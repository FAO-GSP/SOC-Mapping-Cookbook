--- 
title: "Soil Organic Carbon Mapping cookbook"
author: ""
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
output: bookdown::gitbook
documentclass: book
papersize: b5
fontsize: 10pt
bibliography: "References.bib"
biblio-style: plain
link-citations: yes
description: "The soilll cookbook."
---

# reproducible results

Placeholder


## redefine str for the width option
## Boolean object for running all the code #####
## Editorial Board {-}
## Contributing Authors {-}

<!--chapter:end:index.Rmd-->

\mainmatter
\tableofcontents
\listoffigures
\listoftables

# Presentation

Soils provide ecosystem sercives critical to live on Earth. The Food and Agricultural Organization of the United Nations (FAO) recognizes the need to preserve soil resources from degradation and restore them. In 2012, the Global Soil Partnership (GSP) was established to improve soil governance and promote sustainable soil management. 

The GSP aims to promote sustainable soil management at all levels globally through normative tools relying on evidence based science. Understanding the status of a given soil in different land uses, including its properties and functions, and relating this information to the various ecosystem services provided by soils, becomes mandatory for sustainable soil management decisions. As the availability and use of soil data and information is fundamental to underpin these decisions, members of the GSP decided to establish a Global Soil Information System (GLOSIS) based on the development of national soil information systems.

In the process of establishing GLOSIS, a number of tools and networks are being created, including the International Network of Soil Information Institutions (INSII), a [*GSP Soil Data Policy*](http://www.fao.org/3/a-bs975e.pdf) and more. Taking advantage of this process and responding to a request for support in addressing the Sustainable Development Goal Indicators, especially indicator 15.3 which includes the restoration of degraded soils, the GSP Plenary Assembly in 2016 instructed the Intergovernmental Technical Panel on Soils (ITPS) and the GSP Secretariat to develop the first ever Global Soil Organic Carbon Map (GSOCMap) following the same bottom-up approach as GLOSIS. To this end, members under the INSII umbrella developed guidelines and technical specifications for the preparation of the [GSOCMap](http://www.fao.org/3/a-bp164e.pdf) and countries were invited to prepare their national soil organic carbon maps according to these specifications.

Given the scientific advances in tools for mapping soil organic carbon (SOC), many countries requested the GSP Secretariat to support them in the process of preparing national maps, hence an intensive capacity development programme on SOC mapping has been implemented to support countries in this process. Various regional and national training sessions were organized using an on-the-job-training modality to ensure national experts were trained to utilize their own datasets to produce reliable SOC maps. The GSP Secretariat invited a group of experts to prepare a *Soil Organic Carbon Mapping Cookbook* as a comprehensible reference knowledge source to support the capacity development process.

The second edition of the cookbook provides generic methodologies and technical steps to produce SOC maps. This edition has been updated with knowledge and practical experiences gained during the implementaion process of GSOCmap V1.0 throughout 2017. The cookbook includes step-by-step guidance for developing 1 km grids for SOC stocks, as well as for the preparation of local soil data, the compilation and preprocessing of ancillary spatial data sets, upscaling methodologies, and uncertainty assessment methods. Guidance is mainly specific to SOC data, but as this cookbook contains generic sections on soil grid development it can be applicsable to map various soil properties. 

The guidance is focusing on the upscaling of national SOC stocks in order to produce the GSOCMap. Therefore, the cookbook supplements the [*GSP Guidelines for Sharing National Data/Information to Compile a Global Soil Organic Carbon (GSOC) Map*](http://www.fao.org/3/a-bp164e.pdf), providing technical guidelines to prepare and evaluate spatial soil data sets to: 
* Determine SOC stocks from local samples to a target depth of 30 cm;
* Prepare spatial covariates for upscaling; and
* Select and apply the best suitable upscaling methodology.

In terms of statistical upscaling methods, the use of conventional upscaling methods using soil maps and soil profiles is still very common, although this approach is mostly considered empirical by soil mappers. Even though evaluations are based on polygon soil maps, the resulting SOC maps can be rasterized to any target grid. However, a spatially-explicit assessment of uncertainties is impossible. The use of digital soil mapping to upscale local soil information is increasingly applied and recommended.

This cookbook presents two approaches in detail, namely spatial modelling using either regression or data mining analysis, combined with geostatistics such as regression kriging. The second edition includes updates in the section on uncertainty assessment.

It is our hope that this cookbook will fulfill its mandate of easily enabling any user to produce a digital SOC or other soil property map using soil legacy data and modern methods of digital soil mapping with the overall aim for improved decision making on soil management.

<!--chapter:end:02-Presentation.Rmd-->

# Soil Property Maps

*R Baritz*

## Definitions and Objectives

Soil property maps represent spatial information about soil properties to a certain depth or for soil horizons. Conventionally, soil property maps are generated as polygon maps, with properties from typical soil profiles representing soil mapping units.
Digital Soil Mapping (DSM) allows more accurate spatial mapping of soil properties, including the spatial quantification of the prediction error. The quality of such predictions improves with increasing number of local observations (e.g. soil profiles) available to build the prediction model. Whenever possible, DSM is recommended. 

The development of soil property maps via DSM is spatially flexible. For different soil properties (e.g. concentration and stocks of nutrients in the soil, carbon, heavy metals, pH, cation exchange capacity, physical soil properties such as particle sizes and bulk density, etc.), various depth classes and spatial resolution can be modelled depending on project and mapping objectives and available input data. For GSOCmap, a 1 km grid is pursued. The same methodology and input data can also be used to produce higher resolution soil grids.

The mapping of global soil organic carbon (GSOC) stocks will be the first implementation of a series of other soil property grids to be developed for GLOSIS, based on the typical GSP country-driven system. GSOCmap will demonstrate the capacity of countries all around the globe to compile and manage national soil information systems, and to utilize and evaluate these data following agreed international specifications. The GSP Secretariat, FAO and its regional offices, as well as the Regional Soil Partnerships, are challenged together with the GSP members, especially the members of INSII, to establish national capacity and soil data infrastructures to enable soil property mapping. 

## Generic Mapping of Soil Grids: Upscaling of Plot-Level Measurements and Estimates

The following table presents an overview of different geographic upscaling approaches, recommended to produce soil property maps, in particular GSOCmap.

|   |   |                                                                       | 
|-------------------|-------------------------|-----------------------------------------|
| Conventional upscaling [@lettens2004soil]  |  Class-matching | Derive average SOC stocks per class: soil type for which a national map exists, or combination with other spatial covariates (e.g. land use category, climate type, biome, etc.). This approach is used in the absence of spatial coordinates of the source data.  |
|                         | Geomatching     | Point locations with spatial referencing are overlaid with GIS layers of important covariates (e.g. a soil map). Upscaling is based on averaged SOC values per mapping unit.  | 
|  Digital soil mapping [@dobos2006digital]   | Data mining and geostatistics  | Multiple regression, classification tree, random forests, regression kriging, kriging with external drift.  | 


Digital soil mapping is based on the development of functions for upscaling point data (with soil measurements) to a full spatial extent using correlated environmental covariates, for which spatial data are available.

> DSM: Concept of environmental correlation that explores the quantitative relationship among environmental variables and soil properties and could be used to predict the latter with multivariate prediction techniques.


<!--chapter:end:03-Soil-property-maps.Rmd-->


# Setting-Up the Software Environment

Placeholder


## Use of R , RStudio and R Packages
### Obtaining and Installing R
### Obtaining and Installing R Studio
### Getting Started with R
## R Packages
### Finding R Packages
### Most Used R Packages for Digital Soil Mapping 
#### Soil Science and Pedometrics
#### Spatial Analysis
#### Modeling
#### Mapping and Plotting
## R and Spatial Data
### Reading Shapefiles 
### Coordinate Reference Systems (CRS) in R
## print the CRS for the object soilmap
### Working with Rasters
## Other DSM Related Software and Tools

<!--chapter:end:035-software-environment.Rmd-->


# Preparation of Local Soil Property Data

Placeholder


## Soil Profiles and Soil Augers
## Soil Database
### Technical Steps - Loading Data from Tables in R
## Completeness of Measurements and Estimates
### Stones
### Bulk density
### Soil Carbon Analysis
### Carbonates
### Depth
## Completeness of Depth Estimate
### Technical Steps - Equal-Area Splines Using R
#### Promote table `dat` to `SoilProfileCollection`
#### Add site-level data and coordinates
#### Run mass preserving splines for all the needed propierties
## Estimate 0-30 standard horizon usin mass preserving splines
#### Convert back to table
## Prepare final data frame
## Take a look to the results
#### Estimate the soil organic carbon stock using the virtual horizons
## We can save our processed data as a table

<!--chapter:end:04-Preparation.Rmd-->

# Preparation of Spatial covariates
*R Baritz & Y Yigini*

The example covariates from this chapter were prepared by *ISRIC*. The access and use limitations are presented in section [GSOCMap - Data Repository (ISRIC, 2017)]. A small subset of these covariates, comprising most of the soil forming factors, will be used for the examples. This subset is presented in the following table.

```{r details of covariates, echo=F}
covs.t <- read.csv("covs/CovsDescription.csv")
knitr::kable(covs.t[,c(1,3)], caption = "Code and name of example covariates provided with the cookbook.")
```


## DEM-Derived Covariates

### DEM Source Data Sets

Currently, two global level 30 m DEMs are freely available: the Shuttle Radar Topographic Mission (SRTM) and the ASTER Global Digital Elevation Model (GDEM). They provide topographic data at the global scale, which are freely available for users. Both DEMs were compared by @Wong2014. Comparison against high-resolution topographic data of Light Detection and Ranging (LiDAR) in a mountainous tropical montane landscape showed that the SRTM (90 m) produced better topographic data in comparison with ASTER GDEM. 

> * Recommended for national level applications: 30 m GDEM / SRTM.
> * Recommended for global level applications: SRTM 90 m, resampled 1 kilometer.

In both cases noise and artefacts need to be filtered out. ASTER seems to contain more large artefacts (e.g. peaks), particularly in flat terrain, which are very difficult to remove through filtering. 

```{r, fig.cap="SRTM 90m, resampled to 1km for FYROM", warning=FALSE}
#For handling raster data, we load raster package
library(raster)

#load DEM from tif file
DEM <- raster("covs/DEMENV5.tif")
plot(DEM)
```


> *GRASS GIS* or GDAL: Use "mdenoise" module/utility to remove noise while preserving sharp features like ridges, lines and valleys.

SRTM contains many gaps (pixels with no-data). These gaps could be filled using splines. SAGA GIS has a module called ‘Close Gaps with Splines’ and other similar tools for doing this.

## Parent Material

Parent material has a crucial impact on soil formation, soil geochemistry and soil physics. Parent material, if not specifically mapped by soil mappers and included in soil maps, is usually available from geological maps. These maps focus on rock formation, mineral components and age, and often lack younger surface sediments (even in quaternary maps). Parent material/rock types classified by soil mappers considers more strongly geochemistry and rock structure. Its geochemistry has essential impact on the soil chemistry, e.g. cation exchange capacity, base saturation, and nutrient stock. The rock structure determines the ability to disintegrate, which has impact on soil physical properties, like texture, skeleton content, permeability, and soil thickness. 

National parent material and geological maps may be used. Other available datasets and data portals are given on the *ISRIC* [WorldGrids](http://worldgrids.org/doku.php) website. 

* OneGeology: The world geological maps are now being integrated via the OneGeology project which aims at producing a consistent geological map of the world in approximate scale 1:1M [@jackson2007onegeology]; Link: http://www.onegeology.org/.

* *USGS* has several data portals, e.g. that allow browsing of the International Surface Geology (split into South Asia, South America, Iran, Gulf of Mexico, Former Soviet Union, Europe, Caribbean, Bangladesh, Asia Pacific, Arctic, Arabian Peninsula, Africa and Afghanistan); Link: https://mrdata.usgs.gov/geology/world/.

* @hartmann2012new have assembled a global, purely lithological database called GLiM (Global Lithological Map). GLiM consists of over 1.25 million digital polygons that are  classified in three levels (a total of 42 rock-type classes);  Link: https://www.geo.uni-hamburg.de/en/geologie/forschung/geochemie/glim.html).

* *USGS* jointly with *ESRI* has released in 2014 a Global Ecological Land Units map at 250 m resolution. This also includes world layer of rock types. This data can be downloaded from the USGS site (http://rmgsc.cr.usgs.gov/outgoing/ecosystems/Global/).

## Soil Maps

Soil maps play a crucial role for upscaling soil property data from point locations. They can be the spatial layer for conventional upscaling, they can also serve as a covariate in digital soil mapping. Predicted soil property maps have lower quality in areas where the covariates such as relief, geology and climate do not correlate well with the dependent variable, here SOC stocks. This is especially true for soils under groundwater or stagnic water influence. This information is well-represented in soil maps. 

FAO, IIASA, ISRIC, ISS CAS and JRC produced a gridded 1 km soil class map (HWSD). Global HWSD-derived soil property maps can be downloaded as geotiffs at http://worldgrids.org/doku.php/wiki:layers#harmonized_world_soil_database_images_5_km (see also section 3.6).

```{r, fig.cap="soil map of MK", eval=T, fig.width=8}
# load the soil map from a shapefile file
soilmap <- shapefile("MK_soilmap_simple.shp")

# plot the DEM together with the soil types
plot(DEM)
lines(soilmap)
```

> Digitized small-scale national soil maps are the most important spatial layer for soil property mapping. The higher its resolution, the better soil maps contribute to high quality soil property maps - considering that the map should cover the target area/full country coverage.

### Technical Steps - Rasterizing a Vector Layer in R

```{r, eval = T}
# the "Symbol" attribute from the vector layer will be used for the
# rasterization process. It has to be a factor
soilmap@data$Symbol <- as.factor(soilmap@data$Symbol)

#save the levels names in a character vector
Symbol.levels <- levels(soilmap$Symbol)

# The rasterization process needs a layer with the target grd 
# system: spatial extent and cell size.
soilmap.r <- rasterize(x = soilmap, y = DEM, field = "Symbol")
# The DEM raster layer could be used for this.

plot(soilmap.r, col=rainbow(21))
legend("bottomright",legend = Symbol.levels, fill=rainbow(21), 
       cex=0.5)
```

## Land Cover and Land use

Besides soil, geology and climate, land use and/or land cover data are unarguably vital data for any statistical effort to map soil properties. There are many of various sources of data on land cover including global and continental products, such as GlobCover, GeoCover, Globeland30, CORINE Land Cover.

```{r, background=('#F7F7F7'), R.options=(width = 69)}
options(width = 69)
knitr::opts_knit$set(width = 69)
landcover <- raster("covs/LCEE10.tif")

# Land cover is a categorical covariate, this has to be made 
# explicit using function as.factor()
landcover <- as.factor(landcover)
```

### GlobCover (Global)

GlobCover is a European Space Agency (ESA) initiative which began in 2005 in partnership with JRC, EEA, FAO, UNEP, GOFC-GOLD and IGBP. The aim of the project was to develop a service capable of delivering global composites and land cover maps using as input observations from the 300 m MERIS sensor onboard the ENVISAT satellite mission. ESA makes available the land cover maps, which cover 2 periods: December 2004 - June 2006 and January - December 2009. The classification module of the GlobCover processing chain consists in transforming the MERIS-FR multispectral mosaics produced by the pre-processing modules into a meaningful global land cover map. The global land cover map has been produced in an automatic and global way and is associated with a legend defined and documented using the UN LCCS. The GlobCover 2009 land cover map is delivered as one global land cover map covering the entire Earth. Its legend, which counts 22 land cover classes, has been designed to be consistent at the global scale and therefore, it is determined by the level of information that is available and that makes sense at this scale [@bontemps2011globcover]. 
The GlobCover data can be downloaded at: http://due.esrin.esa.int/page_globcover.php

### Landsat GeoCover (Global)

The Landsat GeoCover collection of global imagery was merged into mosaics by the Earth Satellite Company (now MDA Federal). The result was a series of tiled imagery that is easier to wield than individual scenes, especially since they cover larger areas than the originals. The great detail in these mosaic scenes, however, makes them large in storage size, so the Mr.Sid file format, which includes compression operations, was chosen for output. While GeoCover itself is available in three epochs of 1975, 1990 and 2000, only the latter two epochs were made into mosaics. 
Coverage: The GeoCover Landsat mosaics are delivered in a Universal Transverse Mercator (UTM) / World Geodetic System 1984 (WGS84) projection. The mosaics extend north-south over 5 degrees of latitude, and span east-west for the full width of the UTM zone. For mosaics below 60 degrees north latitude, the width of the mosaic is the standard UTM zone width of 6 degrees of longitude. For mosaics above 60 degrees of latitude, the UTM zone is widened to 12 degrees, centred on the standard even-numbered UTM meridians. To insure overlap between adjacent UTM zones, each mosaic extends for at least 50 kilometres to the east and west, and 1 kilometre to the north and south. 
Pixel size: 14.25 meters (V 2000)
The data is available at: ftp://ftp.glcf.umd.edu/glcf/Mosaic_Landsat/ (FTP Access)

### Globeland30 (Global)

GlobeLand30, the world’s first global land cover dataset at 30 m resolution for the years 2000 and 2010, was recently released and made publicly available by China. The National Geomatics Center of China under the “Global Land Cover Mapping at Finer Resolution” project has recently generated a global land cover map named GlobeLand30. The dataset covers two timestamps of 2000 and 2010, primarily acquired from Landsat TM and ETM+ sensors, which were then coupled/checked with some local products. 
The data is publicly available for non-commercial purposes at: http://www.globallandcover.com/GLC30Download/index.aspx   
Further reading and other global data sources: http://worldgrids.org/doku.php/wiki:land_cover_and_land_use 

### CORINE Land Cover (Europe Only)

The pan-European component is coordinated by the European Environment Agency (EEA) and produces satellite image mosaics, land cover / land use (LC/LU) information in the CORINE Land Cover data, and the High Resolution Layers. 
The CORINE Land Cover is provided for 1990, 2000, 2006 and 2012. This vector-based dataset includes 44 land cover and land use classes. The time-series also includes a land-change layer, highlighting changes in land cover and land-use. The high-resolution layers (HRL) are raster-based datasets (100 m, 250 m) which provide information about different land cover characteristics and is complementary to land-cover mapping (e.g. CORINE) datasets.
The CORINE Land Cover Data are available at: http://www.eea.europa.eu/data-and-maps/data 

## Climate

### WorldClim V1.4 and V2 (Global)

WorldClim is a set of global climate layers (gridded climate data) with a spatial resolution of about 1 km2 (10 minutes, 5 minutes, 2.5 minutes are also available). These data can be used for mapping and spatial modelling. The current version is Version 1.4. and a preview of Version 2 is available for testing at worldclim.org. The data can be downloaded as generic grids or in ESRI Grid format.

The WorldClim data layers were generated by interpolation of average monthly climate data from weather stations on a 30 arc-second resolution grid. In V1.4, variables included are monthly total precipitation, and monthly mean, minimum and maximum temperatures, and 19 derived bioclimatic variables. The WorldClim precipitation data were obtained from a network of 1,473 stations, mean temperature from 24,542 stations, and minimum and maximum temperatures from 14,835 stations [@hijmans2005very].

The Bioclimatic parameters are:  annual mean temperature, mean diurnal range, iso-thermality, temperature seasonality, max temperature of warmest month, minimum temperature of coldest month, temperature annual range , mean temperature of wettest quarter, mean temperature of driest quarter, mean temperature of warmest quarter, mean temperature of coldest quarter, annual precipitation, precipitation of wettest month, precipitation of driest month, precipitation seasonality (coefficient of variation), precipitation of wettest quarter, precipitation of driest quarter, precipitation of warmest quarter, precipitation of coldest quarter.

WorldClim Climate Data are available at: www.worldclim.org (WorldClim 1.4 (current conditions) by www.worldclim.org; @hijmans2005very. Is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License).

```{r}
# load the climate covariates from the raster tif files
files <- list.files(path = "covs/", pattern = "CHE3.tif", 
                    full.names = TRUE)

# stack all the files in one RasterStack
climate <- stack(files)
```

```{r, fig.cap="Two layers included in the climate covariates"}
# plot the first 2 layers
plot(climate[[1:2]])
```


### Gridded Agro-Meteorological Data in Europe (Europe)

CGMS database contains meteorological parameters from weather stations interpolated on a 25×25 km grid. Meteorological data are available on a daily basis from 1975 to the last calendar year completed, covering the EU Member States, neighbouring European countries. 

The following parameters are available at 1 day time resolution:

* maximum air temperature (°C)
* minimum air temperature (°C)
* mean air temperature (°C)
* mean daily wind speed at 10m (m/s)
* mean daily vapour pressure (hPa)
* sum of precipitation (mm/day)
* potential evaporation from a free water surface (mm/day)
* potential evapotranspiration from a crop canopy (mm/day)
* potential evaporation from a moist bare soil surface (mm/day)
* total global radiation (KJ/m2/day)
* Snow Depth

Data Access: http://agri4cast.jrc.ec.europa.eu/DataPortal/Index.aspx

## GSOCMap - Data Repository (ISRIC, 2017)

ISRIC World Soil Information has established a data repository which contains raster layers of various biophysical earth surface properties for each territory in the world. These layers can be used as covariates in a digital soil mapping exercise.

### Covariates and Empty Mask

The territories and their boundaries are obtained from the Global Administrative Unit Layers (GAUL)dataset: 
each folder contains three subfolders;
covs: GIS layers of various biophysical earth surface properties
mask: an 'empty'  grid file of the territory with territory boundary according to GAUL. This grid to be used for the final delivery. .
soilgrids: all SoilGrids250m soil class and property layers as available through www.soilgrids.org. Layers are aggregated to 1 km.

### Data Specifications

File format: GeoTiff
Coordinate system: WGS84, latitude-longitude in decimal degrees
Spatial resolution: 1km 

### Data Access

ftp://gsp.isric2.org/  (username: gsp, password: gspisric) or ftp://85.214.253.67/  (username: gsp, password: gspisric)

LICENCE and ACKNOWLEDGEMENT
*The GIS layers can be freely used under the condition that proper credit should be given to the original data source in each publication or product derived from these layers. Licences, data sources, data citations are indicated the data description table.*

## Extending the Soil Property Table for Spatial Statistics

The upscaling procedures (Chapter 6) depend on the rationale that the accumulation of local soil carbon stocks (and also other properties) depend on parameters for which spatial data are available, such as climate, soil type, parent material, slope, management. This information (Covariates) must be collected first. Details are provided above. The properties contained in the covariates can be extracted to each georeferenced sample site and added to the soil property table (Table 3.1). This table is used for training and validation of the statistical model for predicting the SOC stocks which subsequently can be applied to the full spatial extent.

## Preparation of a Soil Property Table for Spatial Statistics

The upscaling procedures (section 4) depend on the rationale, that the accumulation of local soil carbon concentrations and stocks (and also other properties) depends on influential parameters for which spatial data are available, such as climate, soil type, parent material, slope, management. Any parameter in the table of local soil properties, for which a spatial layer is available, may be included in the final table. Other covariates will be added in section 3. An example is the clay content, which may be derived from a soil type or parent rock map. 

> In case this table is prepared for different depths, 0-10 cm, 10-30 cm, and if the host institution intends to develop different spatial models for different depths (e.g. separate spatial prediction model for litter and mineral soil 0-30), then the separate grids have to be added.

## Technical Steps - Mixing Covariates and Soil Points Data

### Load soil sample data and covariates

```{r}
# Load the processed data. This table was prepared in the previous 
# chapter.
dat <- read.csv("data/dataproc.csv")

# read covariates from tif raster files
files <- list.files(path = "covs", pattern = "tif$", 
                    full.names = TRUE)

covs <- stack(files)
```

### Combine the covariates provided with the raster version of the soil map

```{r, fig.cap="FYROM soil covariates"}
# soilmap.r is the rasterization of the soil map and was obtained
# in a previous step
covs <- stack(covs, soilmap.r)

# correct the name for layer 14
names(covs)[14] <- "soilmap"

#mask the covariates with the country mask from the data repository
mask <- raster("data/mask.tif")

covs <- mask(x = covs, mask = mask)

plot(covs)
```

### Extract covariate values at location of the soil samples

```{r}
#upgrade points data frame to SpatialPointsDataFrame
coordinates(dat) <- ~ X + Y

# extract values from covariates to the soil points
dat <- extract(x = covs, y = dat, sp = TRUE)

# LCEE10 and soilmap are categorical variables
dat@data$LCEE10 <- as.factor(dat@data$LCEE10)
dat@data$soilmap <- as.factor(dat@data$soilmap)

levels(soilmap) <- Symbol.levels

summary(dat@data)
```

### Overlay Covariates and Spatial Data

In order to carry out digital soil mapping in terms of examining the statistical significance of environmental predictors for explaining the spatial variation of SOC, we should link both sets of data together and extract the values of the covariates at the locations of the soil point data. Note that the stacking of rasters can only be possible if they are in the same resolution and extent. If they are not, **raster** package resample and `projectRaster()` functions are for harmonising all your different raster layers. With the stacked rasters (Covstack), we can now perform the intersection and extraction.

After the extraction, it's useful to check if there are missing values (`NAs`) both in the target variable and covariates. In these cases, these data should be excluded. A quick way to assess if there are missing or NA values in the data is to use the `complete.cases()` function.

After removing NAs, now there do not appear to be any missing data as indicated by the `integer(0)` output above. It means we have zero rows with missing information.

The last step involves exporting a table our regression matrix including the soil data and the values of the enviromental covariates in position of the point samples.

The summary of the dat data.frame' shows 2 points with NA values for most of the covariates. And 30 points with NA values in the soilmap layer. The regression matrix should not contain NA values. There are two options to proceed:

* In some cases this NA values are from points with bad position data. Therefore the points area outside the study area. In  this case, the solution is to correct the coordinates or eliminate the points. This is the case for the two points with NA values for most of the covariates.

* Another case is when a covariate is incomplete and does not cover all the area. This coul produce many NA values. There are two different solutions, eliminate the covariate or eliminate the point data. This is the case for soilmap layer and the 30 points. 

### Convert result to data.frame and save as a csv table

```{r}
dat <- as.data.frame(dat)

# The points with NA values has to be removed 
dat <- dat[complete.cases(dat),]

# export as a csv table
write.csv(dat, "data/MKD_RegMatrix.csv", row.names = FALSE)
```


<!--chapter:end:05-spatial-covariates.Rmd-->


# Mapping Methods

Placeholder


## Conventional Mapping Using Soil Maps
### Overview
### Technical Steps: Class-matching
#### Data Preparation
#### Preparatory GIS Operations
#### Mapping
### Technical Steps: Geo-Matching
#### Setting Up a QGIS Project
#### Geo-Matching SOC with WRB Soil Map
#### Geo-Matching SOC with Other Environmental Variables: Land Use
#### Joining Landscape Units and Soil Mapping Units to Support Class- and Geo-Matching (Optional)

<!--chapter:end:071-mapping.Rmd-->


# load data

Placeholder


## Regression-Kriging
### Overview
###  Assumptions
### Pre-Processing of Covariates
###  The Terminology
### Interpret the Key Results of Multiple Regression
### Using the Results of a Regression Analysis to Make Predictions
### Technical Steps - Regression Kriging
#### Setting Working Space and Initial Steps
#### Data Preparation
#### Fitting the MLR Model
## stepwise variable selection
#### Prediction and Residual Kriging
### RK model
## Run regression kriging prediction. This step can take hours...!
## Convert prediction and standard deviation to rasters
## And back-tansform the vlaues
## Save results as tif files

<!--chapter:end:072-mapping-RK.Rmd-->


# Correlation analysis to select covariates

Placeholder


## Data mining: Random Forest
### Overview
### Techinical Steps - Random Forest
#### Data Preparation
#### Set the working directory
#### Load the libraries for importing
#### Explore the data
#### Transform the data using Box-Cox transformation
#### Data Processing
#### Splitting the soil data for model testing and training and subsequent performance evaluation.
#### Spatial prediction of the soil organic carbon.

<!--chapter:end:073-mapping-rf.Rmd-->


# load data

Placeholder


## Data minning: Support Vector Machines
### Technical Steps - Fitting a SVM Model to Predict the SOC
#### Setting Working Space and Initial Steps
#### Variable selection using correlation analysis
#### Fitting a svm model using different epsilon and cost parameters
#### Select the model with the best combination of epsilon and cost
#### Predict the OCS using the model

<!--chapter:end:074-mapping-svm.Rmd-->


# Validation

Placeholder


## What is Validation?
## Map Quality Measures
### Quality Measures for Quantitative Soil Maps
### Quality Measures for Qualitative Soil Maps
### Estimating the Map Quality Measures and Associated Uncertainty
## Graphical Map Quality Measures
## Validation Methods and Statistical Inference
### Additional Probability Sampling
### Data-Splitting
### Cross-Validation

<!--chapter:end:08-Validation.Rmd-->


# Uncertainty

Placeholder


## Sources of Uncertainty
### Attribute Uncertainty of Soil Measurements
### Positional Uncertainty of Soil Measurements
### Uncertainty in Covariates
### Uncertainty in Models Predicting Soil Properties From Covariates and Soil Point Data
## Uncertainty and Spatial Data Quality
## Quantifying Prediction Uncertainty
### Uncertainty Characterised by Probability Distributions
### Propagation of Model Uncertainty
### Propagation of Attribute, Positional and Covariate Uncertainty

<!--chapter:end:09-Uncertainty.Rmd-->


# Data Sharing

Placeholder


## Export Formats
### Type of Soil Data and Their Formatting
### General GIS Data Formats: Vector, Raster, Table
### Recommended GIS Data Exchange Formats
## Web Services - Serving Soil Data Using Web Technology
### Third-Party Services
### GeoServer (Web Serving and Web Processing)
### Visualizing Data Using Leaflet and/or Google Earth
## Preparing Soil Data for Distribution
### Metadata
### Exporting Data — Final Tips
## Export Formats 

<!--chapter:end:10-Data-sharing.Rmd-->


# Technical Overview and the Checklist

Placeholder


## Point Dataset 
## Covariates
## Statistical Inference
## Spatial Interpolation
## Calculation of STOCKS 
## Evaluation of Output and Quality Assessment

<!--chapter:end:11-Checklist.Rmd-->

# Deliverables
*Y Yigini*

Data shared by countries will be collected by the GSP Secretariat. The GSP data policy (see GSP GSOC Guidelines, Chapter 8.5) will ensure that the national terms of condition are fully respected.  Data will be shared using common GIS formats, and metadata should be compiled in an excel file. The Soil Organic Carbon Map will be delivered as grid using the 30 arc-seconds grid.

The following data will be delivered:

*	The Soil Organic Carbon Map: will be digitally delivered in grid with 30 arc-seconds resolution. An empty grid is provided by the GSP Secretariat (ftp://gsp.isric2.org/<countryname>/mask/mask.tif). The SOC values should be transferred to this empty grid from the produced SOC data. To transfer values to the empty grid, QGis (Raster Calculator), ArcGIS (Mosaicing tool, Raster Calculator) can be used.
*	Uncertainty Layers and prediction quality figures: a) Qualitative assessment (Conventional Upscaling) b) Quantitative assessment for DSM Methods. The uncertainty associated to the estimated map quality measures will be provided (Mean Error (ME), Mean Absolute Error (MAE), and MSE (Mean Squared Error).
*	Metadata : Metadata is data describing data sets. It provides standardized information about a data set, for example, the maintaining institution through which the data can be accessed. It thus helps a user to find spatial data sets and services and to indicate for which purpose it can be used.
In the case of the GSOC maps, a project-specific metadata template has been prepared. It deviates from the metadata elements listed in common standards such as ISO 19115. Following the guideline for SOC mapping , the importance of soil-specific methodical elements is given. This includes metadata describing the data sources used for SOC mapping and the upscaling method.

<!--chapter:end:12-Deliverables.Rmd-->


# Code examples

Placeholder


## Data Preparation for Soil Profiles
## Estimate 0-30 standard horizon usin mass preserving splines
## Prepare final data frame
## Take a look to the results
## We can save our processed data as a table
## Data Preparation for Top Soil or Auger Samples 
## Take a look to the results
## We can save our processed data as a table
## Mixing Covariates and Soil Points Data
## Fitting a RK model to predict the OCS
## summary  of the new model using stepwise covariates selection
## Save results as tif files
## Fitting a random forest model to predict the SOC
## Fitting a svm model to predict the SOC

<!--chapter:end:13-Code-examples.Rmd-->

