# Preparation of local soil property data
*GF Olmedo & R Baritz*

## Soil profiles and soil augers

Soil profiles are complex real world entities. Soil profiles are composed of soil layers which form soil horizons; the soil layers have different properties and these properties are evaluated with different methods.  As we know, soil and vertical soil properties are landscape elements and part of matter dynamics (water, nutrients, gases, habitat). Local soil samples or soil profiles add a third dimension into the spatial assessment of soil properties in the landscape. 

Most *commonly*, soil are described as vertical profiles using soil pits (sometimes also augerings, but this is less accurate). Soil profiles are described using macro-morphological properties. These properties can be assessed in the field without analysis by making a field inventory or land evaluation. For additional quantitative analysis, soils are then sampled by genetic horizon or by depth class. 

Sampling of soils is the basis to obtain quantitative information. Depending on the goal of a project, sampling can be quite diverse. Sampling can follow the description of the soil, or can be conducted without, for example using a spade or auger to generate a composite sample (for a certain depth independent of the morphological features such as soil horizons). 
Sampling locations can be representative for a certain location, project, field, or mapped object, such as a soil type. 

## Soil database

In order to process and evaluate soil information from field assessments, soil profile and analytical information needs to be stored in a database. This can be a set of simple Excel Spreadsheets, or a relational or object-oriented data base management system [@baritz2008environmental]. When working in R, SoilProfileCollections from the R ‘aqp’ package could be a useful tool. Tables 2.1 – 2.3 are examples of how soil information can be stored. The advantage of such organization is the possibility to develop relational databases which can be easily queried. Such a systematic approach will support the organization of national soil information and will reduce errors in future modelling exercises [@baritz2008environmental].

Table [tab:example table for site-level] stores site-level data, which describe the location of the soil description and/or sampling site: spatial coordinates, landscape attributes such as slope gradient and slope form, soil class, land cover type, rock type etc. In this table every row should hold a single soil profile. One column, usually the first one, should be the soil profile’s unique identifier. Using the latter, soil information can be easily linked from one table to another.

```{r example table for site-level, echo=F}
dat <- read.csv("examples/site-ex.csv")
knitr::kable(dat, caption = "Example for site-level data table")
```

Table \@ref(tab:example table for horizon-level) stores information from the soil description, such as horizon name, horizon thickness, organic matter content, carbonate content, soil color, laboratory soil analysis, etc. The first column contains the soil profile’s unique identifier. It is important to include the upper and lower limits for each soil layer; in case the sampling strategy deviates from soil layers/soil horizons, the upper and lower depth of the sampling locations should be specified if possible. This information is needed for modelling soil properties over the soil profile.


```{r example table for horizon-level, echo=FALSE}
dat <- read.csv("examples/horizons-ex.csv")
knitr::kable(dat, caption = "Example for profile-description table")
```

### Technical Steps - Loading data from tables in R

This chapter includes two examples for data preparation. The first example is for using soil profiles data. This example is mixed with the text but a copy of all the code is presented in section [Data preparation for soil profiles]. The second example is using top soil or auger data and is presented in section [Data preparation for top soil or auger samples].

```{r, results='hold'}
dat <- read.csv(file = "data/horizons.csv")

# Explore the data
str(dat)
summary(dat)
```

```{r}
dat_sites <- read.csv(file = "data/site-level.csv")

# Explore the data
str(dat_sites)
```


## Completeness of measurements/estimates

The GSOC mapping guideline specifies which soil parameters are needed to produce a GSOCmap. Of course, other soil properties can be evaluated and modelled using this cookbook as well.

SOC stocks for soil horizons or targeted soil depths can be calculated using the equations in section 8.4.3 of the “GSP Guidelines for sharing national data/information to compile a Global Soil Organic Carbon map”. Carbon concentration, bulk density and stone content for a certain depth or genetic horizon are needed to calculate the amount of carbon stored in that depth interval/soil horizon. In many countries, legacy data from former surveys and projects as well as from various owners and data sources are compiled. and very often, measured bulk densities are missing or are only available for few soil profiles, or are estimated. Stones in the soil profile are usually only estimated, and if augers are used for sampling, it is not assessed at all. Pedotransfer functions can be used to fill data gaps (bulk density), and interpolation approaches can be used to infer from measured depths to target depths. 

a) Stones

The estimation of stoniness is difficult and time consuming, and therefore not carried out in many national soil inventories, or only estimated visually in the profile. Unfortunately, if soil inventories and sampling are  done with simple pits or augers rather than standard soil pits, stones are very often not assessed. 

As a proxy, it is recommended to derive national default values from well described soil profile pits by soil type.

```{r}
# summary of column CRF (Coarse Fragments) in the example data base
summary(dat$CRF)

# Convert NA's to 0
dat$CRF[is.na(dat$CRF)] <- 0

hist(dat$CRF, col = "light gray")
```


b) Bulk density

The amount of fine earth is one of the basic estimation parameters to estimate SOC stocks in the mineral soil as well as in peat layers. It depends on the volume of soil considered (depth × reference area) and the bulk density (BD). BD expresses the soil weight per unit volume. When determining BD, it is important to subtract stones, if any, from the cylinder samples; if this is not done, BD is underestimated, and the resulting SOC stocks are overestimated. Stones in the cylinders are added to the total stone content in order to correct for the total amount of fine earth per volume of soil in a given area.

Most of the soil profiles in national databases come from agricultural land. Very often, BD estimates do not consider fine stones because top soils (e.g. plough layers) seem to be free of visible stones.

|                 |                        |                                   |
|-----------------|------------------------|-----------------------------------|
Mineral soil | Default values: General Guide for Estimating Moist Bulk Density | If analytical BD is missing, BD can be estimated using pedo-transfer functions (examples are listed below) | 
Forest floor | Default bulk densities: \cite{ottmar_litter_2007} Pine:  L 0.018 g/cm3 ,F/H 0.057 g/cm3 Hardwood L 0.012 g/cm3, F/H 0.043 g/cm3 \cite{barney_forest_1981} 1): Birch: L/H 0.17 g/cm3 Spruce: L 0.051 g/cm3, H 0.13 g/cm3 | L (litter) layer (or Oi horizon, U.S. soil taxonomy) Organic layer, or duff layer: partially decomposed material above the mineral soil and beneath the litter layer; F (fermentation) and H (humus) horizons (Oe and Oa, U.S. soil taxonomy) |
Peat |  Default value: 0.31 g/m3 \citep{batjes1996total} \citep{agus_measuring_2011} distinguish different peat decomposition types (with different C content): Sapric 0.174 (48.90 % C) Hemic 0.117 (52.27% C) Fibric 0.089 (53.56 % C)  | The range of peat BD is generally about 0.02–0.3 t/m3 depending on maturity and compaction, as well as the ash content \citep{agus_measuring_2011} |

Example for Pedotransfer functions to estimate BD, based on the soil organic matter content in percentage:

\begin{equation}
BD = 1.62-0.06 * OM
\end{equation}

\cite{saini_1966_organic}

\begin{equation}
BD = 1/(0.6268 + 0.0361 * OM)
\end{equation}

\cite{Drew1973}

\begin{equation}
BD = 1.482 - 0.6786 * (log OM)
\end{equation}

\cite{jeffrey1970note}

\begin{equation}
BD = 0.669 + 0.941 * e^{(-0,06 * OM)}
\end{equation}

\cite{Grigal1989}

\begin{equation}
BD = 100/(OM/0.244 + (100-OM))/MBD
\end{equation}

\cite{adams1973effect}

\begin{equation}
BD = 1/(0.564 + 0.0556*OM)
\end{equation}

\cite{honeysett1989use}

Where MDB is the  Mineral particle density, assumed to be the specific gravity of quartz, 2.65 Mg m-3. And OM is the Organic Matter Content, estimated as $SOC(\%) ×  1.724$

Each method is derived from a specific set of regional soils that is regionally adapted. Selection of the proper method for a given country shall be based on existing reviews and comparisons. 

```{r}
# Creating a function in R to estimate BLD using the SOC
# SOC is the soil organic carbon content in \%
estimateBD <- function(SOC, method="Saini1996"){
  OM <- SOC * 1.724
  if(method=="Saini1996"){BD <- 1.62 - 0.06 * OM}
  if(method=="Drew1973"){BD <- 1 / (0.6268 + 0.0361 * OM)}
  if(method=="Jeffrey1979"){BD <- 1.482 - 0.6786 * (log(OM))}
  if(method=="Grigal1989"){BD <- 0.669 + 0.941 * exp(1)^(-0.06 * OM)}
  if(method=="Adams1973"){BD <- 100 / (OM /0.244 + (100 - OM)/2.65)}
  if(method=="Honeyset_Ratkowsky1989"){BD <- 1/(0.564 + 0.0556 * OM)}
  return(BD)
}
```



```{r, fig.cap="Histogram of bulk density values"}
# summary of BLD (bulk density) in the example data base
summary(dat$BLD)

# See the summary of values produced using the pedo-transfer 
# function with one of the proposed methods.
summary(estimateBD(dat$SOC[is.na(dat$BLD)], 
                   method="Honeyset_Ratkowsky1989"))

# Fill NA's using the pedotransfer function:
dat$BLD[is.na(dat$BLD)] <- estimateBD(dat$SOC[is.na(dat$BLD)], 
                                      method="Grigal1989")

# explore the results
hist(dat$BLD, col = 'light gray', breaks = 32)
```



c) Soil carbon analysis

\cite{rosell2001soil} have closely reviewed the different SOC and SOM estimation procedures, and have also drawn some conclusions about the sources of errors. Determination of SOC from dry combustion methods is least susceptible to errors.

Dry combustion by Loss on Ignition, LoI: SOC is re-calculated applying a conversion factor: It is commonly assumed, that organic matter contains an average of 58% organic carbon (so-called Van Bemmelen factor 1.724; for non-organic horizons: SOC = SOM / 1.724). For organic horizons, conversion factor ranges from 1.9 to 2.5 \citep{nelson1982total}. The inorganic carbon is not resolved, since typically, temperatures between 400 and 550°C are used.

Wet oxidation: Since wet oxidation is applied without additional (external) heating, low temperatures of around 120° (internal heat) are typical. Thus, the oxidation of carbon is incomplete, and a so-called oxidation factor needs to be applied. With external heating, the C-recovery of the method becomes improved, up to complete recovery. No correction against the mineral carbon is needed. Wet oxidation should typically only be applied to samples with < 5% organic matter.

Usually, an average of 76% organic carbon is recovered, leading to a standard oxidation factor or 1.33 \citep{lettens2005soil}.

d) Carbonates

In case the total organic carbon is determined with temperatures > 600-800°C, the proportion of mineral soil in CaCO3 has to be subtracted in order to derive the amount of organic carbon (inorganic carbon is also oxidized). The pH value gives the first indication whether the sample has to be analyzed for inorganic carbon or not.

It is crucial to report in the metadata whether national SOC values refer to total C or if the inorganic component has been considered.

e) Depth

The standard depth for GSOCmap is **0 to 30 cm**. Subdivisions are possible depending on the available data, by genetic horizon or depth classes. The following depths are additionally considered for GSOC map (optional):
Forest floor: thickness [cm] subdivision in horizons depending on national soil inventory method (e.g. L, F, H)
Peat: > 30 , < 100 depending on national data


## Completeness of depth estimate

Soil properties are commonly collected from the field inventories (see Table 2.2) or from sampling and analysing horizons and/or fixed depths. Since a fixed target depth of 30 cm is required for GSOC (other depth classes will be recommended in the future, following the GlobalSoilMap specifications (reference)), data holders are confronted with the following options: 

* **Option 1**: Soil sampling has already considered this depth: data can be directly used for upscaling see “Upscaling Methods” section)
* **Option 2**: Horizons or layers/depth classes are sampled; but aggregation is needed over the 0-30 cm.
* **Option 3**: The target depth (0-30 cm) was not completely covered by sampling e.g. only the A horizon or a topsoil layer (e.g. 0-20 cm) has been sampled. For both options 2 and 3, additional processing is needed (e.g. equal-area splines).

For both options 2 and 3, transformation is needed using e.g. equal-area splines. In the case of option 2, the use of equal-area splines was first proposed by \cite{ponce1986improved}, and later tested against real data \citep{bishop1999modelling}. This technique is based on fitting continuous depth functions for modelling the variability of soil properties with depth. Thus, it is possible to convert soil profiles to standard depths, but also to fill gaps. The equal-area spline function consists of a series of local quadratic polynomials that join at ’knots’ located at the horizon boundaries thereby the mean value of each horizon is maintained by the spline fit. They are called equal-area splines because the area to the left of the fitted spline curve is equal to the area to the right of the curve.
In case of option 3 additional information on the vertical distribution of carbon in the soils is required for accurate recalculation from the sampling depth to target depth, e.g. as was shown by \cite{bernoux1998modeling}.

### Technical Steps - Equal area splines using R

In R environment, the easiest way to apply equal-area splines is using the function GSIF::mpspline from the R package GSIF (\cite{hengl_2016_gsif}, see section 4.3.2). For illustration, a sample dataset has been used (see Chapter 5.). This function requires data stored as SoilProfileCollection (SPC) using package aqp. Nevertheless, data in any local soil database or in tables like the ones proposed before (Tables 2.1, 2.2 and 2.3) can be transformed to a SPC.

The function GSIF::mpspline has several arguments. One of the arguments is the lambda value mentioned before. The proposed default value is 0.1. Another argument for this function is the target standard depths. The function produces spline-estimated values at these depths. However, this function also produces spline-estimated values at 1 cm increments. 

The following technical steps require ‘R’ and certain packages.

```{r, echo=T}
# Load aqp package
library(aqp)

# Promote to SoilProfileCollection 
# The SoilProfileCollection is a object class in R designed to 
# handle soil profiles
depths(dat) <- ProfID ~ top + bottom

# Merge the soil horizons information with the site-level 
# information from dat_sites
site(dat) <- dat_sites

# Set spatial coordinates
coordinates(dat) <- ~ X + Y

# A summary of our SoilProfileCollection
dat
```


```{r splines, results='hide', message=FALSE, eval=FALSE}
library(GSIF)

## Estimate 0-30 standard horizon usin mass preserving splines
try(SOC <- mpspline(dat, 'SOC', d = t(c(0,30))))
try(BLD <- mpspline(dat, 'BLD', d = t(c(0,30))))
try(CRFVOL <- mpspline(dat, 'CRF', d = t(c(0,30))))
```


```{r, eval=FALSE}
## Prepare final data frame
dat <- data.frame(id = dat@site$ProfID,
                  Y = dat@sp@coords[,2],
                  X = dat@sp@coords[,1],
                  SOC = SOC$var.std[,1],
                  BLD = BLD$var.std[,1],
                  CRFVOL = CRFVOL$var.std[,1])

dat <- dat[complete.cases(dat),]

## Take a look to the results
head(dat)
```

## Organic Carbon Stock 

Finally, the estimation of organic carbon stock could be done using GSIF package:

```{r estimation of OCS, eval=FALSE}
# Estimate Organic Carbon Stock
# SOC must be in g/kg
# BLD in kg/m3
# CRF in percentage
OCSKGM <- OCSKGM(ORCDRC = dat$SOC, BLD = dat$BLD*1000, 
                 CRFVOL = dat$CRFVOL, HSIZE = 30)

dat$OCSKGM <- OCSKGM
dat$meaERROR <- attr(OCSKGM,"measurementError")
dat <- dat[dat$OCSKGM>0,]
summary(dat)

## We can save our processed data as a table
write.csv(dat, "data/dataproc.csv")
```

\clearpage
## Code examples

### Data preparation for soil profiles {#dpsoilprof}

```{r data prep for soil profiles, eval=FALSE}
dat <- read.csv(file = "data/horizons.csv")

# Explore the data
str(dat)
summary(dat)

dat_sites <- read.csv(file = "data/site-level.csv")

# Explore the data
str(dat_sites)

# summary of column CRF (Coarse Fragments) in the example data base
summary(dat$CRF)

# Convert NA's to 0
dat$CRF[is.na(dat$CRF)] <- 0

hist(dat$CRF)

# Creating a function in R to estimate BLD using the SOC
# SOC is the soil organic carbon content in \%
estimateBD <- function(SOC, method="Saini1996"){
  OM <- SOC * 1.724
  if(method=="Saini1996"){BD <- 1.62 - 0.06 * OM}
  if(method=="Drew1973"){BD <- 1 / (0.6268 + 0.0361 * OM)}
  if(method=="Jeffrey1979"){BD <- 1.482 - 0.6786 * (log(OM))}
  if(method=="Grigal1989"){BD <- 0.669 + 0.941 * exp(1)^(-0.06 * OM)}
  if(method=="Adams1973"){BD <- 100 / (OM /0.244 + (100 - OM)/2.65)}
  if(method=="Honeyset_Ratkowsky1989"){BD <- 1/(0.564 + 0.0556 * OM)}
  return(BD)
}

# summary of BLD (bulk density) in the example data base
summary(dat$BLD)

# See the summary of values produced using the pedo-transfer 
# function with one of the proposed methods.
summary(estimateBD(dat$SOC[is.na(dat$BLD)], m
                   ethod="Honeyset_Ratkowsky1989"))

# Fill NA's using the pedotransfer function:
dat$BLD[is.na(dat$BLD)] <- estimateBD(dat$SOC[is.na(dat$BLD)], 
                                      method="Grigal1989")

# explore the results
boxplot(dat$BLD)

# Load aqp package
library(aqp)

# Promote to SoilProfileCollection 
# The SoilProfileCollection is a object class in R designed to 
# handle soil profiles
depths(dat) <- ProfID ~ top + bottom

# Merge the soil horizons information with the site-level 
# information from dat_sites
site(dat) <- dat_sites

# Set spatial coordinates
coordinates(dat) <- ~ X + Y

# A summary of our SoilProfileCollection
dat

library(GSIF)

## Estimate 0-30 standard horizon usin mass preserving splines
try(SOC <- mpspline(dat, 'SOC', d = t(c(0,30))))
try(BLD <- mpspline(dat, 'BLD', d = t(c(0,30))))
try(CRFVOL <- mpspline(dat, 'CRF', d = t(c(0,30))))

## Prepare final data frame
dat <- data.frame(id = dat@site$ProfID,
                  Y = dat@sp@coords[,2],
                  X = dat@sp@coords[,1],
                  SOC = SOC$var.std[,1],
                  BLD = BLD$var.std[,1],
                  CRFVOL = CRFVOL$var.std[,1])

dat <- dat[complete.cases(dat),]

## Take a look to the results
head(dat)

# Estimate Organic Carbon Stock
# SOC must be in g/kg
# BLD in kg/m3
# CRF in percentage
OCSKGM <- OCSKGM(ORCDRC = dat$SOC, BLD = dat$BLD*1000, 
                 CRFVOL = dat$CRFVOL, HSIZE = 30)

dat$OCSKGM <- OCSKGM
dat$meaERROR <- attr(OCSKGM,"measurementError")
dat <- dat[dat$OCSKGM>0,]
summary(dat)

## We can save our processed data as a table
write.csv(dat, "data/dataproc.csv")
```


### Data preparation for top soil or auger samples {#dpauger}

```{r data prep for auger data, eval=FALSE}
dat <- read.csv(file = "data/auger.csv")

# Explore the data
str(dat)
summary(dat)

# Creating a function in R to estimate BLD using the SOC
# SOC is the soil organic carbon content in \%
estimateBD <- function(SOC, method="Saini1996"){
  OM <- SOC * 1.724
  if(method=="Saini1996"){BD <- 1.62 - 0.06 * OM}
  if(method=="Drew1973"){BD <- 1 / (0.6268 + 0.0361 * OM)}
  if(method=="Jeffrey1979"){BD <- 1.482 - 0.6786 * (log(OM))}
  if(method=="Grigal1989"){BD <- 0.669 + 0.941 * exp(1)^(-0.06 * OM)}
  if(method=="Adams1973"){BD <- 100 / (OM /0.244 + (100 - OM)/2.65)}
  if(method=="Honeyset_Ratkowsky1989"){BD <- 1/(0.564 + 0.0556 * OM)}
  return(BD)
}

# See the summary of values produced using the pedo-transfer 
# function with one of the proposed methods.
summary(estimateBD(dat$SOC, method="Honeyset_Ratkowsky1989"))

# Estimate BLD using the pedotransfer function:
dat$BLD <- estimateBD(dat$SOC, method="Grigal1989")

# explore the results
boxplot(dat$BLD)

# Remove points with NA's values
dat <- dat[complete.cases(dat),]

## Take a look to the results
head(dat)

# Estimate Organic Carbon Stock
# SOC must be in g/kg
# BLD in kg/m3
# CRF in percentage
OCSKGM <- OCSKGM(ORCDRC = dat$SOC, BLD = dat$BLD*1000, CRFVOL = 0, 
                 HSIZE = 30)

dat$OCSKGM <- OCSKGM
dat$meaERROR <- attr(OCSKGM,"measurementError")
dat <- dat[dat$OCSKGM>0,]
summary(dat)

## We can save our processed data as a table
write.csv(dat, "data/dataproc.csv")
```
### References

Ottmar RD, Andreu A (2007) Litter and duff bulk densities in the southern United States: final report for Joint Fire Sciences 
Program, Project 04-2-1-49. Pacific Northwest 

Barney, R.J.; Bevins, C.D.; Bradshaw, L.S. 1981. Forest floor fuel loads, depths, and bulk densities. US Dep. Agric., For. Serv., Intermt. For. Range Exp. Stn., Ogden, UT. Res. Note INT-304.

Batjes NH (1996) Total carbon and nitrogen in the soils of the world. European Journal of Soil Science 47, 151-163. 

Agus F, Hairiah K, Mulyani A (2011). Practical guideline measuring carbon stock in peat soils. World Agroforestry Centre (ICRAF) and Indonesia Centre for Agricultural Land Resource Research and Development, Bogor. Pp .60 

Saini, G. R. 1966. Organic matter as a measure of bulk density of soil. Nature 210: 1295-1296.

Drew, L. A. 1973. Bulk density estimation based on organic matter content of some Minnesota soils. Minn. Forestry Res. Note No.243.

Adams, W. A. 1973. The effect of organic matter on the bulk and true densities of some uncultivated Podzolic soils. J. Soil Sci. 24: 10-17.

Grigal, D.F., Brovold, S.L., Nord, W.S., and Ohmann, L.F. 1989. Bulk density of surface soils and peat in the north central United States. Can. J. Soil Sci. 69: 895–900

Jeffrey, D. W. 1970. A note on the use of ignition loss as a means for the approximate estimation of soil bulk density. J. Ecol. 58:297-299.

Honeysett JL, Ratkowsky DA (1989). The Use of Ignition Loss to Estimate Bulk Density of Forest Soils. J. Soil Sci., 40: 299-308. 

Rosell A, Gasparoni JC, Galantini JA (2001) ‘Soil organic matter evaluation.’ Assessment methods for soil carbon, Advances in Soil Science. (Eds R Lal, JM Kimble, RF Follet, BA Stewart) pp. 311–322. (Lewis Publishers: Boca Raton, FL, USA)

Nelson, D.W. and L.E. Sommers, 1982. Total carbon, organic carbon and organic matter: In: A.L. Page, R.H. Miller and D.R. Keeney) Methods of soil analysis. Part 2 Chemical and Microbiological Properties, pp: 539-579.

Lettens S, van Orshoven J, van Wesemael B, Muys B, Perrin D. Soil organic carbon changes in landscape units of Belgium between 1960 and 2000 with reference to 1990. Global Change Biology. 2005;11:2128–2140.

Ponce‐Hernandez, R., Marriott, F.H.C., Beckett, P.H.T., 1986. An improved method forreconstructing a soil profile from analyses of a small number of samples. Journal of Soil Science 37, 455–467.

Bishop, Thomas & Mcbratney, Alex & Laslett, G.M.. (1999). Modeling soil attribute depth functions with equal-area quadratic smoothing splines. Geoderma. 91. 27-45. 10.1016/S0016-7061(99)00003-8. 

Bernoux, M., D. Arrouays, C. C. Cerrri, and H. Bourennane. 1998. Modeling vertical distribution of carbon in oxisols of the western Brazilian Amazon (Rondonia). Soil Sci. 163: 941-951
