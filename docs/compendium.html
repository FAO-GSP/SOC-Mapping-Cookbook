<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Soil Organic Carbon Mapping Cookbook</title>
  <meta name="description" content="The soilll cookbook.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Soil Organic Carbon Mapping Cookbook" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="images/cover.png" />
  <meta property="og:description" content="The soilll cookbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Soil Organic Carbon Mapping Cookbook" />
  
  <meta name="twitter:description" content="The soilll cookbook." />
  <meta name="twitter:image" content="images/cover.png" />

<meta name="author" content="Food and Agriculture Organization of the United Nations, Rome, 2018">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="technical-overview-and-the-checklist.html">
<link rel="next" href="references.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>List of contributors</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#editorial-board"><i class="fa fa-check"></i>Editorial board</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contributing-authors"><i class="fa fa-check"></i>Contributing authors</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="presentation.html"><a href="presentation.html"><i class="fa fa-check"></i><b>1</b> Presentation</a><ul>
<li class="chapter" data-level="1.1" data-path="presentation.html"><a href="presentation.html#how-to-use-this-book"><i class="fa fa-check"></i><b>1.1</b> How to use this book</a></li>
<li class="chapter" data-level="1.2" data-path="presentation.html"><a href="presentation.html#the-fyrom-soil-database"><i class="fa fa-check"></i><b>1.2</b> The FYROM soil database</a></li>
<li class="chapter" data-level="1.3" data-path="presentation.html"><a href="presentation.html#foreword-to-the-first-edition"><i class="fa fa-check"></i><b>1.3</b> Foreword to the first edition</a></li>
<li class="chapter" data-level="1.4" data-path="presentation.html"><a href="presentation.html#foreword-to-the-second-edition"><i class="fa fa-check"></i><b>1.4</b> Foreword to the second edition</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="soil-property-maps.html"><a href="soil-property-maps.html"><i class="fa fa-check"></i><b>2</b> Soil property maps</a><ul>
<li class="chapter" data-level="2.1" data-path="soil-property-maps.html"><a href="soil-property-maps.html#definitions-and-objectives"><i class="fa fa-check"></i><b>2.1</b> Definitions and objectives</a></li>
<li class="chapter" data-level="2.2" data-path="soil-property-maps.html"><a href="soil-property-maps.html#generic-mapping-of-soil-grids-upscaling-of-plot-level-measurements-and-estimates"><i class="fa fa-check"></i><b>2.2</b> Generic mapping of soil grids: upscaling of plot-Level measurements and estimates</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html"><i class="fa fa-check"></i><b>3</b> Setting-up the software environment</a><ul>
<li class="chapter" data-level="3.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#use-of-r-rstudio-and-r-packages"><i class="fa fa-check"></i><b>3.1</b> Use of R, RStudio and R Packages</a><ul>
<li class="chapter" data-level="3.1.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-r"><i class="fa fa-check"></i><b>3.1.1</b> Obtaining and installing R</a></li>
<li class="chapter" data-level="3.1.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#obtaining-and-installing-rstudio"><i class="fa fa-check"></i><b>3.1.2</b> Obtaining and installing RStudio</a></li>
<li class="chapter" data-level="3.1.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#getting-started-with-r"><i class="fa fa-check"></i><b>3.1.3</b> Getting started with R</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-packages"><i class="fa fa-check"></i><b>3.2</b> R packages</a><ul>
<li class="chapter" data-level="3.2.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#finding-r-packages"><i class="fa fa-check"></i><b>3.2.1</b> Finding R packages</a></li>
<li class="chapter" data-level="3.2.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#most-used-r-packages-for-digital-soil-mapping"><i class="fa fa-check"></i><b>3.2.2</b> Most used R packages for digital soil mapping</a></li>
<li class="chapter" data-level="3.2.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#packages-used-in-this-cookbook"><i class="fa fa-check"></i><b>3.2.3</b> Packages used in this cookbook</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#r-and-spatial-data"><i class="fa fa-check"></i><b>3.3</b> R and spatial data</a><ul>
<li class="chapter" data-level="3.3.1" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#reading-shapefiles"><i class="fa fa-check"></i><b>3.3.1</b> Reading shapefiles</a></li>
<li class="chapter" data-level="3.3.2" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#coordinate-reference-systems-in-r"><i class="fa fa-check"></i><b>3.3.2</b> Coordinate reference systems in R</a></li>
<li class="chapter" data-level="3.3.3" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#working-with-rasters"><i class="fa fa-check"></i><b>3.3.3</b> Working with rasters</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="setting-up-the-software-environment.html"><a href="setting-up-the-software-environment.html#other-dsm-software-and-tools"><i class="fa fa-check"></i><b>3.4</b> Other DSM software and tools</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="preparation.html"><a href="preparation.html"><i class="fa fa-check"></i><b>4</b> Preparation of local soil data</a><ul>
<li class="chapter" data-level="4.1" data-path="preparation.html"><a href="preparation.html#soil-profiles-and-soil-augers"><i class="fa fa-check"></i><b>4.1</b> Soil profiles and soil augers</a></li>
<li class="chapter" data-level="4.2" data-path="preparation.html"><a href="preparation.html#soil-database"><i class="fa fa-check"></i><b>4.2</b> Soil database</a><ul>
<li class="chapter" data-level="4.2.1" data-path="preparation.html"><a href="preparation.html#type-of-soil-database"><i class="fa fa-check"></i><b>4.2.1</b> Type of soil database</a></li>
<li class="chapter" data-level="4.2.2" data-path="preparation.html"><a href="preparation.html#technical-steps-loading-soil-data-from-tables-in-r"><i class="fa fa-check"></i><b>4.2.2</b> Technical steps – Loading soil data from tables in R</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="preparation.html"><a href="preparation.html#completeness-of-measurements-and-estimates"><i class="fa fa-check"></i><b>4.3</b> Completeness of measurements and estimates</a><ul>
<li class="chapter" data-level="4.3.1" data-path="preparation.html"><a href="preparation.html#stones"><i class="fa fa-check"></i><b>4.3.1</b> Stones</a></li>
<li class="chapter" data-level="4.3.2" data-path="preparation.html"><a href="preparation.html#bulk-density"><i class="fa fa-check"></i><b>4.3.2</b> Bulk density</a></li>
<li class="chapter" data-level="4.3.3" data-path="preparation.html"><a href="preparation.html#soil-carbon-analysis"><i class="fa fa-check"></i><b>4.3.3</b> Soil carbon analysis</a></li>
<li class="chapter" data-level="4.3.4" data-path="preparation.html"><a href="preparation.html#carbonates"><i class="fa fa-check"></i><b>4.3.4</b> Carbonates</a></li>
<li class="chapter" data-level="4.3.5" data-path="preparation.html"><a href="preparation.html#depth"><i class="fa fa-check"></i><b>4.3.5</b> Depth</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="preparation.html"><a href="preparation.html#soil-depth-estimate"><i class="fa fa-check"></i><b>4.4</b> Soil depth estimate</a><ul>
<li class="chapter" data-level="4.4.1" data-path="preparation.html"><a href="preparation.html#completeness-of-depth-estimate"><i class="fa fa-check"></i><b>4.4.1</b> Completeness of depth estimate</a></li>
<li class="chapter" data-level="4.4.2" data-path="preparation.html"><a href="preparation.html#EqualAreaSplines"><i class="fa fa-check"></i><b>4.4.2</b> Technical steps - Equal-area splines using R</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="covariates.html"><a href="covariates.html"><i class="fa fa-check"></i><b>5</b> Preparation of spatial covariates</a><ul>
<li class="chapter" data-level="5.1" data-path="covariates.html"><a href="covariates.html#dem-derived-covariates"><i class="fa fa-check"></i><b>5.1</b> DEM-derived covariates</a></li>
<li class="chapter" data-level="5.2" data-path="covariates.html"><a href="covariates.html#parent-material"><i class="fa fa-check"></i><b>5.2</b> Parent material</a></li>
<li class="chapter" data-level="5.3" data-path="covariates.html"><a href="covariates.html#soil-maps"><i class="fa fa-check"></i><b>5.3</b> Soil maps</a><ul>
<li class="chapter" data-level="5.3.1" data-path="covariates.html"><a href="covariates.html#global-hwsd-soil-property-maps"><i class="fa fa-check"></i><b>5.3.1</b> Global HWSD soil property maps</a></li>
<li class="chapter" data-level="5.3.2" data-path="covariates.html"><a href="covariates.html#technical-steps---rasterizing-a-vector-layer-in-r"><i class="fa fa-check"></i><b>5.3.2</b> Technical steps - Rasterizing a vector layer in R</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="covariates.html"><a href="covariates.html#land-cover-and-land-use"><i class="fa fa-check"></i><b>5.4</b> Land cover and land use</a><ul>
<li class="chapter" data-level="5.4.1" data-path="covariates.html"><a href="covariates.html#globcover-global"><i class="fa fa-check"></i><b>5.4.1</b> GlobCover (Global)</a></li>
<li class="chapter" data-level="5.4.2" data-path="covariates.html"><a href="covariates.html#landsat-geocover-global"><i class="fa fa-check"></i><b>5.4.2</b> Landsat GeoCover (Global)</a></li>
<li class="chapter" data-level="5.4.3" data-path="covariates.html"><a href="covariates.html#globeland30-global"><i class="fa fa-check"></i><b>5.4.3</b> GlobeLand30 (Global)</a></li>
<li class="chapter" data-level="5.4.4" data-path="covariates.html"><a href="covariates.html#corine-land-cover-europe-only"><i class="fa fa-check"></i><b>5.4.4</b> CORINE land cover (Europe only)</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="covariates.html"><a href="covariates.html#climate"><i class="fa fa-check"></i><b>5.5</b> Climate</a><ul>
<li class="chapter" data-level="5.5.1" data-path="covariates.html"><a href="covariates.html#worldclim-v1.4-and-v2-global"><i class="fa fa-check"></i><b>5.5.1</b> WorldClim V1.4 and V2 (Global)</a></li>
<li class="chapter" data-level="5.5.2" data-path="covariates.html"><a href="covariates.html#gridded-agro-meteorological-data-in-europe-europe"><i class="fa fa-check"></i><b>5.5.2</b> Gridded agro-meteorological data in Europe (Europe)</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="covariates.html"><a href="covariates.html#GSOCDataRepo"><i class="fa fa-check"></i><b>5.6</b> GSOCMap - Data repository (ISRIC, 2017)</a><ul>
<li class="chapter" data-level="5.6.1" data-path="covariates.html"><a href="covariates.html#covariates-and-empty-mask"><i class="fa fa-check"></i><b>5.6.1</b> Covariates and empty mask</a></li>
<li class="chapter" data-level="5.6.2" data-path="covariates.html"><a href="covariates.html#data-specifications"><i class="fa fa-check"></i><b>5.6.2</b> Data specifications</a></li>
<li class="chapter" data-level="5.6.3" data-path="covariates.html"><a href="covariates.html#data-access"><i class="fa fa-check"></i><b>5.6.3</b> Data access</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="covariates.html"><a href="covariates.html#extending-the-soil-property-table-for-spatial-statistics"><i class="fa fa-check"></i><b>5.7</b> Extending the soil property table for spatial statistics</a></li>
<li class="chapter" data-level="5.8" data-path="covariates.html"><a href="covariates.html#preparation-of-a-soil-property-table-for-spatial-statistics"><i class="fa fa-check"></i><b>5.8</b> Preparation of a soil property table for spatial statistics</a></li>
<li class="chapter" data-level="5.9" data-path="covariates.html"><a href="covariates.html#overlay-soil-covariates"><i class="fa fa-check"></i><b>5.9</b> Technical steps - Overlay covariates and soil points data</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mappingMethods.html"><a href="mappingMethods.html"><i class="fa fa-check"></i><b>6</b> Mapping methods</a><ul>
<li class="chapter" data-level="6.1" data-path="mappingMethods.html"><a href="mappingMethods.html#convUpscaling"><i class="fa fa-check"></i><b>6.1</b> Conventional upscaling using soil maps</a><ul>
<li class="chapter" data-level="6.1.1" data-path="mappingMethods.html"><a href="mappingMethods.html#overview"><i class="fa fa-check"></i><b>6.1.1</b> Overview</a></li>
<li class="chapter" data-level="6.1.2" data-path="mappingMethods.html"><a href="mappingMethods.html#diversity-of-national-soil-legacy-data-sets"><i class="fa fa-check"></i><b>6.1.2</b> Diversity of national soil legacy data sets</a></li>
<li class="chapter" data-level="6.1.3" data-path="mappingMethods.html"><a href="mappingMethods.html#technical-steps---class-matching"><i class="fa fa-check"></i><b>6.1.3</b> Technical steps - Class-matching</a></li>
<li class="chapter" data-level="6.1.4" data-path="mappingMethods.html"><a href="mappingMethods.html#geomQGIS"><i class="fa fa-check"></i><b>6.1.4</b> Technical steps - Geo-matching</a></li>
<li class="chapter" data-level="6.1.5" data-path="mappingMethods.html"><a href="mappingMethods.html#technical-steps---geo-matching-soc-with-wrb-soil-map-in-r"><i class="fa fa-check"></i><b>6.1.5</b> Technical steps - Geo-matching SOC with WRB soil map in R</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="mappingMethods.html"><a href="mappingMethods.html#RK"><i class="fa fa-check"></i><b>6.2</b> Regression-Kriging</a><ul>
<li class="chapter" data-level="6.2.1" data-path="mappingMethods.html"><a href="mappingMethods.html#overview-1"><i class="fa fa-check"></i><b>6.2.1</b> Overview</a></li>
<li class="chapter" data-level="6.2.2" data-path="mappingMethods.html"><a href="mappingMethods.html#assumptions"><i class="fa fa-check"></i><b>6.2.2</b> Assumptions</a></li>
<li class="chapter" data-level="6.2.3" data-path="mappingMethods.html"><a href="mappingMethods.html#pre-processing-of-covariates"><i class="fa fa-check"></i><b>6.2.3</b> Pre-processing of covariates</a></li>
<li class="chapter" data-level="6.2.4" data-path="mappingMethods.html"><a href="mappingMethods.html#the-terminology"><i class="fa fa-check"></i><b>6.2.4</b> The terminology</a></li>
<li class="chapter" data-level="6.2.5" data-path="mappingMethods.html"><a href="mappingMethods.html#interpret-the-key-results-of-multiple-regression"><i class="fa fa-check"></i><b>6.2.5</b> Interpret the Key Results of Multiple Regression</a></li>
<li class="chapter" data-level="6.2.6" data-path="mappingMethods.html"><a href="mappingMethods.html#using-the-results-of-a-regression-analysis-to-make-predictions"><i class="fa fa-check"></i><b>6.2.6</b> Using the results of a regression analysis to make predictions</a></li>
<li class="chapter" data-level="6.2.7" data-path="mappingMethods.html"><a href="mappingMethods.html#technical-steps---regression-kriging"><i class="fa fa-check"></i><b>6.2.7</b> Technical steps - Regression-kriging</a></li>
<li class="chapter" data-level="6.2.8" data-path="mappingMethods.html"><a href="mappingMethods.html#technical-steps---cross-validation-of-regression-kriging-models"><i class="fa fa-check"></i><b>6.2.8</b> Technical steps - Cross-validation of regression-kriging models</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="mappingMethods.html"><a href="mappingMethods.html#rf"><i class="fa fa-check"></i><b>6.3</b> Data mining: random forest</a><ul>
<li class="chapter" data-level="6.3.1" data-path="mappingMethods.html"><a href="mappingMethods.html#overview-2"><i class="fa fa-check"></i><b>6.3.1</b> Overview</a></li>
<li class="chapter" data-level="6.3.2" data-path="mappingMethods.html"><a href="mappingMethods.html#random-forest"><i class="fa fa-check"></i><b>6.3.2</b> Random forest</a></li>
<li class="chapter" data-level="6.3.3" data-path="mappingMethods.html"><a href="mappingMethods.html#conceptual-model-and-data-preparation"><i class="fa fa-check"></i><b>6.3.3</b> Conceptual model and data preparation</a></li>
<li class="chapter" data-level="6.3.4" data-path="mappingMethods.html"><a href="mappingMethods.html#software"><i class="fa fa-check"></i><b>6.3.4</b> Software</a></li>
<li class="chapter" data-level="6.3.5" data-path="mappingMethods.html"><a href="mappingMethods.html#tunning-random-forest-model-parameters"><i class="fa fa-check"></i><b>6.3.5</b> Tunning random forest model parameters</a></li>
<li class="chapter" data-level="6.3.6" data-path="mappingMethods.html"><a href="mappingMethods.html#technical-steps---random-forest"><i class="fa fa-check"></i><b>6.3.6</b> Technical steps - Random forest</a></li>
<li class="chapter" data-level="6.3.7" data-path="mappingMethods.html"><a href="mappingMethods.html#technical-steps---using-quantile-regression-forest-to-estimate-uncertainty"><i class="fa fa-check"></i><b>6.3.7</b> Technical steps - Using quantile regression forest to estimate uncertainty</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="mappingMethods.html"><a href="mappingMethods.html#svm"><i class="fa fa-check"></i><b>6.4</b> Data mining: support vector machines</a><ul>
<li class="chapter" data-level="6.4.1" data-path="mappingMethods.html"><a href="mappingMethods.html#overview-3"><i class="fa fa-check"></i><b>6.4.1</b> Overview</a></li>
<li class="chapter" data-level="6.4.2" data-path="mappingMethods.html"><a href="mappingMethods.html#technical-steps---fitting-an-svm-model-to-predict-the-soc"><i class="fa fa-check"></i><b>6.4.2</b> Technical steps - Fitting an SVM model to predict the SOC</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="chvalidation.html"><a href="chvalidation.html"><i class="fa fa-check"></i><b>7</b> Validation</a><ul>
<li class="chapter" data-level="7.1" data-path="chvalidation.html"><a href="chvalidation.html#what-is-validation"><i class="fa fa-check"></i><b>7.1</b> What is validation?</a></li>
<li class="chapter" data-level="7.2" data-path="chvalidation.html"><a href="chvalidation.html#QualMeasures"><i class="fa fa-check"></i><b>7.2</b> Map quality measures</a><ul>
<li class="chapter" data-level="7.2.1" data-path="chvalidation.html"><a href="chvalidation.html#quality-measures-for-quantitative-soil-maps"><i class="fa fa-check"></i><b>7.2.1</b> Quality measures for quantitative soil maps</a></li>
<li class="chapter" data-level="7.2.2" data-path="chvalidation.html"><a href="chvalidation.html#quality-measures-for-qualitative-soil-maps"><i class="fa fa-check"></i><b>7.2.2</b> Quality measures for qualitative soil maps</a></li>
<li class="chapter" data-level="7.2.3" data-path="chvalidation.html"><a href="chvalidation.html#estimating-the-map-quality-measures-and-associated-uncertainty"><i class="fa fa-check"></i><b>7.2.3</b> Estimating the map quality measures and associated uncertainty</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="chvalidation.html"><a href="chvalidation.html#graphical-map-quality-measures"><i class="fa fa-check"></i><b>7.3</b> Graphical map quality measures</a></li>
<li class="chapter" data-level="7.4" data-path="chvalidation.html"><a href="chvalidation.html#validationMeth"><i class="fa fa-check"></i><b>7.4</b> Validation methods and statistical inference</a><ul>
<li class="chapter" data-level="7.4.1" data-path="chvalidation.html"><a href="chvalidation.html#addProbSampling"><i class="fa fa-check"></i><b>7.4.1</b> Additional probability sampling</a></li>
<li class="chapter" data-level="7.4.2" data-path="chvalidation.html"><a href="chvalidation.html#data-splitting"><i class="fa fa-check"></i><b>7.4.2</b> Data-splitting</a></li>
<li class="chapter" data-level="7.4.3" data-path="chvalidation.html"><a href="chvalidation.html#xval"><i class="fa fa-check"></i><b>7.4.3</b> Cross-validation</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="chvalidation.html"><a href="chvalidation.html#TS:validation"><i class="fa fa-check"></i><b>7.5</b> Technical steps - Validation</a></li>
<li class="chapter" data-level="7.6" data-path="chvalidation.html"><a href="chvalidation.html#dataSplit"><i class="fa fa-check"></i><b>7.6</b> Technical steps - Data-splitting</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="evaluation.html"><a href="evaluation.html"><i class="fa fa-check"></i><b>8</b> Model evaluation in digital soil mapping</a><ul>
<li class="chapter" data-level="8.1" data-path="evaluation.html"><a href="evaluation.html#technical-steps---model-correlations-and-spatial-differences"><i class="fa fa-check"></i><b>8.1</b> Technical steps - Model correlations and spatial differences</a></li>
<li class="chapter" data-level="8.2" data-path="evaluation.html"><a href="evaluation.html#technical-steps---model-evaluation"><i class="fa fa-check"></i><b>8.2</b> Technical steps - Model evaluation</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="uncertainty.html"><a href="uncertainty.html"><i class="fa fa-check"></i><b>9</b> Uncertainty</a><ul>
<li class="chapter" data-level="9.1" data-path="uncertainty.html"><a href="uncertainty.html#sourcesuncert"><i class="fa fa-check"></i><b>9.1</b> Sources of uncertainty</a><ul>
<li class="chapter" data-level="9.1.1" data-path="uncertainty.html"><a href="uncertainty.html#attribute-uncertainty-of-soil-measurements"><i class="fa fa-check"></i><b>9.1.1</b> Attribute uncertainty of soil measurements</a></li>
<li class="chapter" data-level="9.1.2" data-path="uncertainty.html"><a href="uncertainty.html#positional-uncertainty-of-soil-measurements"><i class="fa fa-check"></i><b>9.1.2</b> Positional uncertainty of soil measurements</a></li>
<li class="chapter" data-level="9.1.3" data-path="uncertainty.html"><a href="uncertainty.html#uncertainty-in-covariates"><i class="fa fa-check"></i><b>9.1.3</b> Uncertainty in covariates</a></li>
<li class="chapter" data-level="9.1.4" data-path="uncertainty.html"><a href="uncertainty.html#uncertainty-in-models-predicting-soil-properties-from-covariates-and-soil-point-data"><i class="fa fa-check"></i><b>9.1.4</b> Uncertainty in models predicting soil properties from covariates and soil point data</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="uncertainty.html"><a href="uncertainty.html#uncertainty-and-spatial-data-quality"><i class="fa fa-check"></i><b>9.2</b> Uncertainty and spatial data quality</a></li>
<li class="chapter" data-level="9.3" data-path="uncertainty.html"><a href="uncertainty.html#quantifying-prediction-uncertainty"><i class="fa fa-check"></i><b>9.3</b> Quantifying prediction uncertainty</a><ul>
<li class="chapter" data-level="9.3.1" data-path="uncertainty.html"><a href="uncertainty.html#uncertainty-characterised-by-probability-distributions"><i class="fa fa-check"></i><b>9.3.1</b> Uncertainty characterised by probability distributions</a></li>
<li class="chapter" data-level="9.3.2" data-path="uncertainty.html"><a href="uncertainty.html#propagation-of-model-uncertainty"><i class="fa fa-check"></i><b>9.3.2</b> Propagation of model uncertainty</a></li>
<li class="chapter" data-level="9.3.3" data-path="uncertainty.html"><a href="uncertainty.html#propUncertainty"><i class="fa fa-check"></i><b>9.3.3</b> Propagation of attribute, positional and covariate uncertainty</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="data-sharing.html"><a href="data-sharing.html"><i class="fa fa-check"></i><b>10</b> Data sharing</a><ul>
<li class="chapter" data-level="10.1" data-path="data-sharing.html"><a href="data-sharing.html#export-formats"><i class="fa fa-check"></i><b>10.1</b> Export formats</a><ul>
<li class="chapter" data-level="10.1.1" data-path="data-sharing.html"><a href="data-sharing.html#type-of-soil-data-and-their-formatting"><i class="fa fa-check"></i><b>10.1.1</b> Type of soil data and their formatting</a></li>
<li class="chapter" data-level="10.1.2" data-path="data-sharing.html"><a href="data-sharing.html#general-gis-data-formats-vector-raster-table"><i class="fa fa-check"></i><b>10.1.2</b> General GIS data formats: vector, raster, table</a></li>
<li class="chapter" data-level="10.1.3" data-path="data-sharing.html"><a href="data-sharing.html#recommended-gis-data-exchange-formats"><i class="fa fa-check"></i><b>10.1.3</b> Recommended GIS data exchange formats</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="data-sharing.html"><a href="data-sharing.html#webService"><i class="fa fa-check"></i><b>10.2</b> Web services: serving soil data using web technology</a><ul>
<li class="chapter" data-level="10.2.1" data-path="data-sharing.html"><a href="data-sharing.html#third-party-services"><i class="fa fa-check"></i><b>10.2.1</b> Third-party services</a></li>
<li class="chapter" data-level="10.2.2" data-path="data-sharing.html"><a href="data-sharing.html#geoserver-web-serving-and-web-processing"><i class="fa fa-check"></i><b>10.2.2</b> GeoServer (web serving and web processing)</a></li>
<li class="chapter" data-level="10.2.3" data-path="data-sharing.html"><a href="data-sharing.html#visualizing-data-using-leaflet-andor-google-earth"><i class="fa fa-check"></i><b>10.2.3</b> Visualizing data using Leaflet and/or Google Earth</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="data-sharing.html"><a href="data-sharing.html#preparing-soil-data-for-distribution"><i class="fa fa-check"></i><b>10.3</b> Preparing soil data for distribution</a><ul>
<li class="chapter" data-level="10.3.1" data-path="data-sharing.html"><a href="data-sharing.html#metadata"><i class="fa fa-check"></i><b>10.3.1</b> Metadata</a></li>
<li class="chapter" data-level="10.3.2" data-path="data-sharing.html"><a href="data-sharing.html#exporting-data-final-tips"><i class="fa fa-check"></i><b>10.3.2</b> Exporting data: final tips</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="data-sharing.html"><a href="data-sharing.html#export-formats-1"><i class="fa fa-check"></i><b>10.4</b> Export formats</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="technical-overview-and-the-checklist.html"><a href="technical-overview-and-the-checklist.html"><i class="fa fa-check"></i><b>11</b> Technical overview and the checklist</a><ul>
<li class="chapter" data-level="11.1" data-path="technical-overview-and-the-checklist.html"><a href="technical-overview-and-the-checklist.html#point-dataset"><i class="fa fa-check"></i><b>11.1</b> Point dataset</a></li>
<li class="chapter" data-level="11.2" data-path="technical-overview-and-the-checklist.html"><a href="technical-overview-and-the-checklist.html#covariates-1"><i class="fa fa-check"></i><b>11.2</b> Covariates</a></li>
<li class="chapter" data-level="11.3" data-path="technical-overview-and-the-checklist.html"><a href="technical-overview-and-the-checklist.html#statistical-inference"><i class="fa fa-check"></i><b>11.3</b> Statistical inference</a></li>
<li class="chapter" data-level="11.4" data-path="technical-overview-and-the-checklist.html"><a href="technical-overview-and-the-checklist.html#spatial-interpolation"><i class="fa fa-check"></i><b>11.4</b> Spatial interpolation</a></li>
<li class="chapter" data-level="11.5" data-path="technical-overview-and-the-checklist.html"><a href="technical-overview-and-the-checklist.html#calculation-of-stocks"><i class="fa fa-check"></i><b>11.5</b> Calculation of stocks</a></li>
<li class="chapter" data-level="11.6" data-path="technical-overview-and-the-checklist.html"><a href="technical-overview-and-the-checklist.html#evaluation-of-output-and-quality-assessment"><i class="fa fa-check"></i><b>11.6</b> Evaluation of output and quality assessment</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="compendium.html"><a href="compendium.html"><i class="fa fa-check"></i><b>12</b> Compendium of the code examples</a><ul>
<li class="chapter" data-level="12.1" data-path="compendium.html"><a href="compendium.html#cd:PreparationProfiles"><i class="fa fa-check"></i><b>12.1</b> Data preparation for soil profiles</a></li>
<li class="chapter" data-level="12.2" data-path="compendium.html"><a href="compendium.html#cd:PreparationAuger"><i class="fa fa-check"></i><b>12.2</b> Data preparation for topsoil or auger samples</a></li>
<li class="chapter" data-level="12.3" data-path="compendium.html"><a href="compendium.html#cd:merging"><i class="fa fa-check"></i><b>12.3</b> Merging topsoil or auger samples and soil profiles databases</a></li>
<li class="chapter" data-level="12.4" data-path="compendium.html"><a href="compendium.html#cd:data-splitting"><i class="fa fa-check"></i><b>12.4</b> Data-splitting</a></li>
<li class="chapter" data-level="12.5" data-path="compendium.html"><a href="compendium.html#cd:Rasterizing"><i class="fa fa-check"></i><b>12.5</b> Rasterizing a vector layer in R</a></li>
<li class="chapter" data-level="12.6" data-path="compendium.html"><a href="compendium.html#cd:Overlay"><i class="fa fa-check"></i><b>12.6</b> Overlay covariates and soil points data</a></li>
<li class="chapter" data-level="12.7" data-path="compendium.html"><a href="compendium.html#cd:RK"><i class="fa fa-check"></i><b>12.7</b> Fitting a regression-kriging model to predict the SOC stock</a></li>
<li class="chapter" data-level="12.8" data-path="compendium.html"><a href="compendium.html#cd:xvalRK"><i class="fa fa-check"></i><b>12.8</b> Cross-validation of regression-kriging models</a></li>
<li class="chapter" data-level="12.9" data-path="compendium.html"><a href="compendium.html#cd:rf"><i class="fa fa-check"></i><b>12.9</b> Fitting a random forest model to predict the SOC stock</a></li>
<li class="chapter" data-level="12.10" data-path="compendium.html"><a href="compendium.html#cd:quantreg"><i class="fa fa-check"></i><b>12.10</b> Using quantile regression forest to estimate uncertainty</a></li>
<li class="chapter" data-level="12.11" data-path="compendium.html"><a href="compendium.html#cd:svm"><i class="fa fa-check"></i><b>12.11</b> Fitting a support vector machines model to predict the SOC stock</a></li>
<li class="chapter" data-level="12.12" data-path="compendium.html"><a href="compendium.html#cd:Validation"><i class="fa fa-check"></i><b>12.12</b> Validation</a></li>
<li class="chapter" data-level="12.13" data-path="compendium.html"><a href="compendium.html#cd:Graphs"><i class="fa fa-check"></i><b>12.13</b> Graphical map quality measures</a></li>
<li class="chapter" data-level="12.14" data-path="compendium.html"><a href="compendium.html#cd:Evaluation"><i class="fa fa-check"></i><b>12.14</b> Model evaluation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Soil Organic Carbon Mapping Cookbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="compendium" class="section level1">
<h1><span class="header-section-number">Chapter 12</span> Compendium of the code examples</h1>
<p><em>G.F. Olmedo</em></p>
<p>This technical manual gives relatively simple step-by-step guidance on DSM. Guidance is mainly on mapping and modelling of soil organic carbon, but also contains generic sections on soil grid development that can be used to map various soil properties. The document follows the typical DSM work-flow and provides users a complete soil property mapping solution from the ground up (see Fig. <a href="presentation.html#fig:grworkflow">1.1</a>).</p>
<p>The authors have demonstrated the methods in the previous Chapters using a dataset extracted from the Macedonian Soil Information System (MASIS). In this Chapter we present a compendium of the technical steps presented in the practical chapters.</p>
<p>With the help of these examples, the user should be able to produce a soil property map starting from ground data to the validation of the map. There are also optional work-flow steps depending on the nature of the input data. The <strong>framework</strong> presented in this manual is aiming to help users preparing a soil property prediction map includes soil data preparation, preparation of environmental covariates, overlaying soil data and covariates, fitting a model for the spatial interpolation and validation:</p>
<ol style="list-style-type: decimal">
<li>Soil data preparation</li>
</ol>
<ul>
<li><strong>Option A</strong>: Data preparation - Soil profiles (Code <a href="compendium.html#cd:PreparationProfiles">12.1</a>)</li>
<li><strong>Option B</strong>: Data preparation - Topsoil or auger samples (Code <a href="compendium.html#cd:PreparationAuger">12.2</a>)</li>
<li><em>[optional]</em> Data preparation - Merging topsoil or auger samples and soil profiles (Code <a href="compendium.html#cd:merging">12.3</a>)</li>
<li><em>[optional]</em> Split the soil data in test and validations datasets (Code <a href="compendium.html#cd:data-splitting">12.4</a>)</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Covariates preparation</li>
</ol>
<ul>
<li><em>[optional]</em> Rasterizing a vector layer in <strong>R</strong> (Code <a href="compendium.html#cd:Rasterizing">12.5</a>)</li>
<li>Overlay covariates and soil points data (Code <a href="compendium.html#cd:Overlay">12.6</a>)</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>Spatial interpolation model</li>
</ol>
<ul>
<li><strong>Option A</strong>: Fitting a regression-kriging model to predict the SOC stock (Code <a href="compendium.html#cd:RK">12.7</a>)</li>
<li><strong>Option B</strong>: Fitting a random forest model to predict the SOC stock (Code <a href="compendium.html#cd:rf">12.9</a>)</li>
<li><strong>Option C</strong>: Fitting a support vector machines model to predict the SOC stock (Code <a href="compendium.html#cd:svm">12.11</a>)</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Validation</li>
</ol>
<ul>
<li>Quality measures for quantitative data (Code <a href="compendium.html#cd:Validation">12.12</a>)</li>
<li><em>[optional]</em> Graphical quality measures for quantitative data (Code <a href="compendium.html#cd:Graphs">12.13</a>)</li>
<li><em>[optional]</em> Cross-validation for regression-kriging models (Code <a href="compendium.html#cd:xvalRK">12.8</a>)</li>
<li><em>[optional]</em> Validation of random forest using quantile regression trees (Code <a href="compendium.html#cd:quantreg">12.10</a>)</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li>Model evaluation</li>
</ol>
<ul>
<li>Model evaluation (Code <a href="compendium.html#cd:Evaluation">12.14</a>)</li>
</ul>

<div id="cd:PreparationProfiles" class="section level2">
<h2><span class="header-section-number">12.1</span> Data preparation for soil profiles</h2>
<p>The extended and discussed version of the following code is presented in Chapter <a href="preparation.html#preparation">4</a>, by G.F. Olmedo &amp; R. Baritz.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb220-1" data-line-number="1">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="dt">file =</span> <span class="st">&quot;data/horizons.csv&quot;</span>)</a>
<a class="sourceLine" id="cb220-2" data-line-number="2"></a>
<a class="sourceLine" id="cb220-3" data-line-number="3"><span class="co"># Explore the data</span></a>
<a class="sourceLine" id="cb220-4" data-line-number="4"><span class="kw">str</span>(dat)</a>
<a class="sourceLine" id="cb220-5" data-line-number="5"><span class="kw">summary</span>(dat)</a>
<a class="sourceLine" id="cb220-6" data-line-number="6"></a>
<a class="sourceLine" id="cb220-7" data-line-number="7">dat_sites &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="dt">file =</span> <span class="st">&quot;data/site-level.csv&quot;</span>)</a>
<a class="sourceLine" id="cb220-8" data-line-number="8"></a>
<a class="sourceLine" id="cb220-9" data-line-number="9"><span class="co"># Explore the data</span></a>
<a class="sourceLine" id="cb220-10" data-line-number="10"><span class="kw">str</span>(dat_sites)</a>
<a class="sourceLine" id="cb220-11" data-line-number="11"></a>
<a class="sourceLine" id="cb220-12" data-line-number="12"><span class="co"># summary of column CRF (Coarse Fragments) in the example data base</span></a>
<a class="sourceLine" id="cb220-13" data-line-number="13"><span class="kw">summary</span>(dat<span class="op">$</span>CRF)</a>
<a class="sourceLine" id="cb220-14" data-line-number="14"></a>
<a class="sourceLine" id="cb220-15" data-line-number="15"><span class="co"># Convert NA&#39;s to 0</span></a>
<a class="sourceLine" id="cb220-16" data-line-number="16">dat<span class="op">$</span>CRF[<span class="kw">is.na</span>(dat<span class="op">$</span>CRF)] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb220-17" data-line-number="17"></a>
<a class="sourceLine" id="cb220-18" data-line-number="18"><span class="kw">hist</span>(dat<span class="op">$</span>CRF)</a>
<a class="sourceLine" id="cb220-19" data-line-number="19"></a>
<a class="sourceLine" id="cb220-20" data-line-number="20"><span class="co"># Creating a function in R to estimate BLD using the SOC</span></a>
<a class="sourceLine" id="cb220-21" data-line-number="21"><span class="co"># SOC is the soil organic carbon content in \%</span></a>
<a class="sourceLine" id="cb220-22" data-line-number="22">estimateBD &lt;-<span class="st"> </span><span class="cf">function</span>(SOC, <span class="dt">method=</span><span class="st">&quot;Saini1996&quot;</span>){</a>
<a class="sourceLine" id="cb220-23" data-line-number="23">  OM &lt;-<span class="st"> </span>SOC <span class="op">*</span><span class="st"> </span><span class="fl">1.724</span></a>
<a class="sourceLine" id="cb220-24" data-line-number="24">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Saini1996&quot;</span>){BD &lt;-<span class="st"> </span><span class="fl">1.62</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.06</span> <span class="op">*</span><span class="st"> </span>OM}</a>
<a class="sourceLine" id="cb220-25" data-line-number="25">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Drew1973&quot;</span>){BD &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="fl">0.6268</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.0361</span> <span class="op">*</span><span class="st"> </span>OM)}</a>
<a class="sourceLine" id="cb220-26" data-line-number="26">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Jeffrey1979&quot;</span>){BD &lt;-<span class="st"> </span><span class="fl">1.482</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.6786</span> <span class="op">*</span><span class="st"> </span>(<span class="kw">log</span>(OM))}</a>
<a class="sourceLine" id="cb220-27" data-line-number="27">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Grigal1989&quot;</span>){BD &lt;-<span class="st"> </span><span class="fl">0.669</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.941</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="dv">1</span>)<span class="op">^</span>(<span class="op">-</span><span class="fl">0.06</span> <span class="op">*</span><span class="st"> </span>OM)}</a>
<a class="sourceLine" id="cb220-28" data-line-number="28">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Adams1973&quot;</span>){BD &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">/</span><span class="st"> </span>(OM <span class="op">/</span><span class="fl">0.244</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">100</span> <span class="op">-</span><span class="st"> </span>OM)<span class="op">/</span><span class="fl">2.65</span>)}</a>
<a class="sourceLine" id="cb220-29" data-line-number="29">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>){BD &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span>(<span class="fl">0.564</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.0556</span> <span class="op">*</span><span class="st"> </span>OM)}</a>
<a class="sourceLine" id="cb220-30" data-line-number="30">  <span class="kw">return</span>(BD)</a>
<a class="sourceLine" id="cb220-31" data-line-number="31">}</a>
<a class="sourceLine" id="cb220-32" data-line-number="32"></a>
<a class="sourceLine" id="cb220-33" data-line-number="33"><span class="co"># summary of BLD (bulk density) in the example data base</span></a>
<a class="sourceLine" id="cb220-34" data-line-number="34"><span class="kw">summary</span>(dat<span class="op">$</span>BLD)</a>
<a class="sourceLine" id="cb220-35" data-line-number="35"></a>
<a class="sourceLine" id="cb220-36" data-line-number="36"><span class="co"># See the summary of values produced using the pedo-transfer</span></a>
<a class="sourceLine" id="cb220-37" data-line-number="37"><span class="co"># function with one of the proposed methods.</span></a>
<a class="sourceLine" id="cb220-38" data-line-number="38"><span class="kw">summary</span>(<span class="kw">estimateBD</span>(dat<span class="op">$</span>SOC[<span class="kw">is.na</span>(dat<span class="op">$</span>BLD)], m</a>
<a class="sourceLine" id="cb220-39" data-line-number="39">                   <span class="dt">ethod=</span><span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>))</a>
<a class="sourceLine" id="cb220-40" data-line-number="40"></a>
<a class="sourceLine" id="cb220-41" data-line-number="41"><span class="co"># Fill NA&#39;s using the pedotransfer function:</span></a>
<a class="sourceLine" id="cb220-42" data-line-number="42">dat<span class="op">$</span>BLD[<span class="kw">is.na</span>(dat<span class="op">$</span>BLD)] &lt;-<span class="st"> </span><span class="kw">estimateBD</span>(dat<span class="op">$</span>SOC[<span class="kw">is.na</span>(dat<span class="op">$</span>BLD)],</a>
<a class="sourceLine" id="cb220-43" data-line-number="43">                                      <span class="dt">method=</span><span class="st">&quot;Grigal1989&quot;</span>)</a>
<a class="sourceLine" id="cb220-44" data-line-number="44"></a>
<a class="sourceLine" id="cb220-45" data-line-number="45"><span class="co"># explore the results</span></a>
<a class="sourceLine" id="cb220-46" data-line-number="46"><span class="kw">boxplot</span>(dat<span class="op">$</span>BLD)</a>
<a class="sourceLine" id="cb220-47" data-line-number="47"></a>
<a class="sourceLine" id="cb220-48" data-line-number="48"><span class="co"># Load aqp package</span></a>
<a class="sourceLine" id="cb220-49" data-line-number="49"><span class="kw">library</span>(aqp)</a>
<a class="sourceLine" id="cb220-50" data-line-number="50"></a>
<a class="sourceLine" id="cb220-51" data-line-number="51"><span class="co"># Promote to SoilProfileCollection</span></a>
<a class="sourceLine" id="cb220-52" data-line-number="52"><span class="co"># The SoilProfileCollection is a object class in R designed to</span></a>
<a class="sourceLine" id="cb220-53" data-line-number="53"><span class="co"># handle soil profiles</span></a>
<a class="sourceLine" id="cb220-54" data-line-number="54"><span class="kw">depths</span>(dat) &lt;-<span class="st"> </span>ProfID <span class="op">~</span><span class="st"> </span>top <span class="op">+</span><span class="st"> </span>bottom</a>
<a class="sourceLine" id="cb220-55" data-line-number="55"></a>
<a class="sourceLine" id="cb220-56" data-line-number="56"><span class="co"># Merge the soil horizons information with the site-level</span></a>
<a class="sourceLine" id="cb220-57" data-line-number="57"><span class="co"># information from dat_sites</span></a>
<a class="sourceLine" id="cb220-58" data-line-number="58"><span class="kw">site</span>(dat) &lt;-<span class="st"> </span>dat_sites</a>
<a class="sourceLine" id="cb220-59" data-line-number="59"></a>
<a class="sourceLine" id="cb220-60" data-line-number="60"><span class="co"># Set spatial coordinates</span></a>
<a class="sourceLine" id="cb220-61" data-line-number="61"><span class="kw">coordinates</span>(dat) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>Y</a>
<a class="sourceLine" id="cb220-62" data-line-number="62"></a>
<a class="sourceLine" id="cb220-63" data-line-number="63"><span class="co"># A summary of our SoilProfileCollection</span></a>
<a class="sourceLine" id="cb220-64" data-line-number="64">dat</a>
<a class="sourceLine" id="cb220-65" data-line-number="65"></a>
<a class="sourceLine" id="cb220-66" data-line-number="66"><span class="kw">library</span>(GSIF)</a>
<a class="sourceLine" id="cb220-67" data-line-number="67"></a>
<a class="sourceLine" id="cb220-68" data-line-number="68">## Estimate 0-30 standard horizon usin mass preserving splines</a>
<a class="sourceLine" id="cb220-69" data-line-number="69"><span class="kw">try</span>(SOC &lt;-<span class="st"> </span><span class="kw">mpspline</span>(dat, <span class="st">&#39;SOC&#39;</span>, <span class="dt">d =</span> <span class="kw">t</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">30</span>))))</a>
<a class="sourceLine" id="cb220-70" data-line-number="70"><span class="kw">try</span>(BLD &lt;-<span class="st"> </span><span class="kw">mpspline</span>(dat, <span class="st">&#39;BLD&#39;</span>, <span class="dt">d =</span> <span class="kw">t</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">30</span>))))</a>
<a class="sourceLine" id="cb220-71" data-line-number="71"><span class="kw">try</span>(CRFVOL &lt;-<span class="st"> </span><span class="kw">mpspline</span>(dat, <span class="st">&#39;CRF&#39;</span>, <span class="dt">d =</span> <span class="kw">t</span>(<span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">30</span>))))</a>
<a class="sourceLine" id="cb220-72" data-line-number="72"></a>
<a class="sourceLine" id="cb220-73" data-line-number="73">## Prepare final data frame</a>
<a class="sourceLine" id="cb220-74" data-line-number="74">dat &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> dat<span class="op">@</span>site<span class="op">$</span>ProfID,</a>
<a class="sourceLine" id="cb220-75" data-line-number="75">                  <span class="dt">Y =</span> dat<span class="op">@</span>sp<span class="op">@</span>coords[,<span class="dv">2</span>],</a>
<a class="sourceLine" id="cb220-76" data-line-number="76">                  <span class="dt">X =</span> dat<span class="op">@</span>sp<span class="op">@</span>coords[,<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb220-77" data-line-number="77">                  <span class="dt">SOC =</span> SOC<span class="op">$</span>var.std[,<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb220-78" data-line-number="78">                  <span class="dt">BLD =</span> BLD<span class="op">$</span>var.std[,<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb220-79" data-line-number="79">                  <span class="dt">CRFVOL =</span> CRFVOL<span class="op">$</span>var.std[,<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb220-80" data-line-number="80"></a>
<a class="sourceLine" id="cb220-81" data-line-number="81">dat &lt;-<span class="st"> </span>dat[<span class="kw">complete.cases</span>(dat),]</a>
<a class="sourceLine" id="cb220-82" data-line-number="82"></a>
<a class="sourceLine" id="cb220-83" data-line-number="83">## Take a look to the results</a>
<a class="sourceLine" id="cb220-84" data-line-number="84"><span class="kw">head</span>(dat)</a>
<a class="sourceLine" id="cb220-85" data-line-number="85"></a>
<a class="sourceLine" id="cb220-86" data-line-number="86"><span class="co"># Estimate Organic Carbon Stock</span></a>
<a class="sourceLine" id="cb220-87" data-line-number="87"><span class="co"># SOC must be in g/kg</span></a>
<a class="sourceLine" id="cb220-88" data-line-number="88"><span class="co"># BLD in kg/m3</span></a>
<a class="sourceLine" id="cb220-89" data-line-number="89"><span class="co"># CRF in percentage</span></a>
<a class="sourceLine" id="cb220-90" data-line-number="90">OCSKGM &lt;-<span class="st"> </span><span class="kw">OCSKGM</span>(<span class="dt">ORCDRC =</span> dat<span class="op">$</span>SOC, <span class="dt">BLD =</span> dat<span class="op">$</span>BLD<span class="op">*</span><span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb220-91" data-line-number="91">                 <span class="dt">CRFVOL =</span> dat<span class="op">$</span>CRFVOL, <span class="dt">HSIZE =</span> <span class="dv">30</span>)</a>
<a class="sourceLine" id="cb220-92" data-line-number="92"></a>
<a class="sourceLine" id="cb220-93" data-line-number="93">dat<span class="op">$</span>OCSKGM &lt;-<span class="st"> </span>OCSKGM</a>
<a class="sourceLine" id="cb220-94" data-line-number="94">dat<span class="op">$</span>meaERROR &lt;-<span class="st"> </span><span class="kw">attr</span>(OCSKGM,<span class="st">&quot;measurementError&quot;</span>)</a>
<a class="sourceLine" id="cb220-95" data-line-number="95">dat &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>OCSKGM<span class="op">&gt;</span><span class="dv">0</span>,]</a>
<a class="sourceLine" id="cb220-96" data-line-number="96"><span class="kw">summary</span>(dat)</a>
<a class="sourceLine" id="cb220-97" data-line-number="97"></a>
<a class="sourceLine" id="cb220-98" data-line-number="98">## We can save our processed data as a table</a>
<a class="sourceLine" id="cb220-99" data-line-number="99"><span class="kw">write.csv</span>(dat, <span class="st">&quot;data/dataproc.csv&quot;</span>)</a></code></pre></div>

</div>
<div id="cd:PreparationAuger" class="section level2">
<h2><span class="header-section-number">12.2</span> Data preparation for topsoil or auger samples</h2>
<p>The extended and discussed version of the following code is presented in Chapter <a href="preparation.html#preparation">4</a>, by G.F. Olmedo &amp; R. Baritz.</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb221-1" data-line-number="1">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="dt">file =</span> <span class="st">&quot;data/auger.csv&quot;</span>)</a>
<a class="sourceLine" id="cb221-2" data-line-number="2"></a>
<a class="sourceLine" id="cb221-3" data-line-number="3"><span class="co"># Explore the data</span></a>
<a class="sourceLine" id="cb221-4" data-line-number="4"><span class="kw">str</span>(dat)</a>
<a class="sourceLine" id="cb221-5" data-line-number="5"><span class="kw">summary</span>(dat)</a>
<a class="sourceLine" id="cb221-6" data-line-number="6"></a>
<a class="sourceLine" id="cb221-7" data-line-number="7"><span class="co"># Creating a function in R to estimate BLD using the SOC</span></a>
<a class="sourceLine" id="cb221-8" data-line-number="8"><span class="co"># SOC is the soil organic carbon content in \%</span></a>
<a class="sourceLine" id="cb221-9" data-line-number="9">estimateBD &lt;-<span class="st"> </span><span class="cf">function</span>(SOC, <span class="dt">method=</span><span class="st">&quot;Saini1996&quot;</span>){</a>
<a class="sourceLine" id="cb221-10" data-line-number="10">  OM &lt;-<span class="st"> </span>SOC <span class="op">*</span><span class="st"> </span><span class="fl">1.724</span></a>
<a class="sourceLine" id="cb221-11" data-line-number="11">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Saini1996&quot;</span>){BD &lt;-<span class="st"> </span><span class="fl">1.62</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.06</span> <span class="op">*</span><span class="st"> </span>OM}</a>
<a class="sourceLine" id="cb221-12" data-line-number="12">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Drew1973&quot;</span>){BD &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>(<span class="fl">0.6268</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.0361</span> <span class="op">*</span><span class="st"> </span>OM)}</a>
<a class="sourceLine" id="cb221-13" data-line-number="13">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Jeffrey1979&quot;</span>){BD &lt;-<span class="st"> </span><span class="fl">1.482</span> <span class="op">-</span><span class="st"> </span><span class="fl">0.6786</span> <span class="op">*</span><span class="st"> </span>(<span class="kw">log</span>(OM))}</a>
<a class="sourceLine" id="cb221-14" data-line-number="14">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Grigal1989&quot;</span>){BD &lt;-<span class="st"> </span><span class="fl">0.669</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.941</span> <span class="op">*</span><span class="st"> </span><span class="kw">exp</span>(<span class="dv">1</span>)<span class="op">^</span>(<span class="op">-</span><span class="fl">0.06</span> <span class="op">*</span><span class="st"> </span>OM)}</a>
<a class="sourceLine" id="cb221-15" data-line-number="15">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Adams1973&quot;</span>){BD &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">/</span><span class="st"> </span>(OM <span class="op">/</span><span class="fl">0.244</span> <span class="op">+</span><span class="st"> </span>(<span class="dv">100</span> <span class="op">-</span><span class="st"> </span>OM)<span class="op">/</span><span class="fl">2.65</span>)}</a>
<a class="sourceLine" id="cb221-16" data-line-number="16">  <span class="cf">if</span>(method<span class="op">==</span><span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>){BD &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">/</span>(<span class="fl">0.564</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.0556</span> <span class="op">*</span><span class="st"> </span>OM)}</a>
<a class="sourceLine" id="cb221-17" data-line-number="17">  <span class="kw">return</span>(BD)</a>
<a class="sourceLine" id="cb221-18" data-line-number="18">}</a>
<a class="sourceLine" id="cb221-19" data-line-number="19"></a>
<a class="sourceLine" id="cb221-20" data-line-number="20"><span class="co"># See the summary of values produced using the pedo-transfer</span></a>
<a class="sourceLine" id="cb221-21" data-line-number="21"><span class="co"># function with one of the proposed methods.</span></a>
<a class="sourceLine" id="cb221-22" data-line-number="22"><span class="kw">summary</span>(<span class="kw">estimateBD</span>(dat<span class="op">$</span>SOC, <span class="dt">method=</span><span class="st">&quot;Honeyset_Ratkowsky1989&quot;</span>))</a>
<a class="sourceLine" id="cb221-23" data-line-number="23"></a>
<a class="sourceLine" id="cb221-24" data-line-number="24"><span class="co"># Estimate BLD using the pedotransfer function:</span></a>
<a class="sourceLine" id="cb221-25" data-line-number="25">dat<span class="op">$</span>BLD &lt;-<span class="st"> </span><span class="kw">estimateBD</span>(dat<span class="op">$</span>SOC, <span class="dt">method=</span><span class="st">&quot;Grigal1989&quot;</span>)</a>
<a class="sourceLine" id="cb221-26" data-line-number="26"></a>
<a class="sourceLine" id="cb221-27" data-line-number="27"><span class="co"># explore the results</span></a>
<a class="sourceLine" id="cb221-28" data-line-number="28"><span class="kw">boxplot</span>(dat<span class="op">$</span>BLD)</a>
<a class="sourceLine" id="cb221-29" data-line-number="29"></a>
<a class="sourceLine" id="cb221-30" data-line-number="30"><span class="co"># Remove points with NA&#39;s values</span></a>
<a class="sourceLine" id="cb221-31" data-line-number="31">dat &lt;-<span class="st"> </span>dat[<span class="kw">complete.cases</span>(dat),]</a>
<a class="sourceLine" id="cb221-32" data-line-number="32"></a>
<a class="sourceLine" id="cb221-33" data-line-number="33">## Take a look to the results</a>
<a class="sourceLine" id="cb221-34" data-line-number="34"><span class="kw">head</span>(dat)</a>
<a class="sourceLine" id="cb221-35" data-line-number="35"></a>
<a class="sourceLine" id="cb221-36" data-line-number="36"><span class="kw">library</span>(GSIF)</a>
<a class="sourceLine" id="cb221-37" data-line-number="37"><span class="co"># Estimate Organic Carbon Stock</span></a>
<a class="sourceLine" id="cb221-38" data-line-number="38"><span class="co"># SOC must be in g/kg</span></a>
<a class="sourceLine" id="cb221-39" data-line-number="39"><span class="co"># BLD in kg/m3</span></a>
<a class="sourceLine" id="cb221-40" data-line-number="40"><span class="co"># CRF in percentage</span></a>
<a class="sourceLine" id="cb221-41" data-line-number="41">OCSKGM &lt;-<span class="st"> </span><span class="kw">OCSKGM</span>(<span class="dt">ORCDRC =</span> dat<span class="op">$</span>SOC, <span class="dt">BLD =</span> dat<span class="op">$</span>BLD<span class="op">*</span><span class="dv">1000</span>, <span class="dt">CRFVOL =</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb221-42" data-line-number="42">                 <span class="dt">HSIZE =</span> <span class="dv">30</span>)</a>
<a class="sourceLine" id="cb221-43" data-line-number="43"></a>
<a class="sourceLine" id="cb221-44" data-line-number="44">dat<span class="op">$</span>OCSKGM &lt;-<span class="st"> </span>OCSKGM</a>
<a class="sourceLine" id="cb221-45" data-line-number="45">dat<span class="op">$</span>meaERROR &lt;-<span class="st"> </span><span class="kw">attr</span>(OCSKGM,<span class="st">&quot;measurementError&quot;</span>)</a>
<a class="sourceLine" id="cb221-46" data-line-number="46">dat &lt;-<span class="st"> </span>dat[dat<span class="op">$</span>OCSKGM<span class="op">&gt;</span><span class="dv">0</span>,]</a>
<a class="sourceLine" id="cb221-47" data-line-number="47"><span class="kw">summary</span>(dat)</a>
<a class="sourceLine" id="cb221-48" data-line-number="48"></a>
<a class="sourceLine" id="cb221-49" data-line-number="49">## We can save our processed data as a table</a>
<a class="sourceLine" id="cb221-50" data-line-number="50"><span class="kw">write.csv</span>(dat, <span class="st">&quot;data/dataproc.csv&quot;</span>)</a></code></pre></div>

</div>
<div id="cd:merging" class="section level2">
<h2><span class="header-section-number">12.3</span> Merging topsoil or auger samples and soil profiles databases</h2>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb222-1" data-line-number="1">profiles &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/dataproc_profiles.csv&quot;</span>)</a>
<a class="sourceLine" id="cb222-2" data-line-number="2">topsoils &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/dataproc.csv&quot;</span>)</a>
<a class="sourceLine" id="cb222-3" data-line-number="3"></a>
<a class="sourceLine" id="cb222-4" data-line-number="4"></a>
<a class="sourceLine" id="cb222-5" data-line-number="5"><span class="co"># column names could be different, but the units and order has</span></a>
<a class="sourceLine" id="cb222-6" data-line-number="6"><span class="co"># to be the same! Because we are going to add the rows from 1</span></a>
<a class="sourceLine" id="cb222-7" data-line-number="7"><span class="co"># table to the other table.</span></a>
<a class="sourceLine" id="cb222-8" data-line-number="8"></a>
<a class="sourceLine" id="cb222-9" data-line-number="9">topsoils &lt;-<span class="st"> </span>topsoils[, <span class="kw">c</span>(<span class="st">&quot;ID&quot;</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>, <span class="st">&quot;SOC&quot;</span>, <span class="st">&quot;BLD&quot;</span>,</a>
<a class="sourceLine" id="cb222-10" data-line-number="10">                         <span class="st">&quot;OCSKGM&quot;</span>, <span class="st">&quot;meaERROR&quot;</span>)]</a>
<a class="sourceLine" id="cb222-11" data-line-number="11"></a>
<a class="sourceLine" id="cb222-12" data-line-number="12">profiles &lt;-<span class="st"> </span>profiles[, <span class="kw">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;X&quot;</span>, <span class="st">&quot;Y&quot;</span>, <span class="st">&quot;SOC&quot;</span>, <span class="st">&quot;BLD&quot;</span>,</a>
<a class="sourceLine" id="cb222-13" data-line-number="13">                         <span class="st">&quot;OCSKGM&quot;</span>, <span class="st">&quot;meaERROR&quot;</span>)]</a>
<a class="sourceLine" id="cb222-14" data-line-number="14"></a>
<a class="sourceLine" id="cb222-15" data-line-number="15"><span class="kw">names</span>(profiles) &lt;-<span class="st"> </span><span class="kw">names</span>(topsoils)</a>
<a class="sourceLine" id="cb222-16" data-line-number="16">dat &lt;-<span class="st"> </span><span class="kw">rbind</span>(topsoils, profiles)</a>
<a class="sourceLine" id="cb222-17" data-line-number="17"></a>
<a class="sourceLine" id="cb222-18" data-line-number="18"><span class="kw">write.csv</span>(dat, <span class="st">&quot;data/dataproc_all.csv&quot;</span>, <span class="dt">row.names =</span> F)</a></code></pre></div>

</div>
<div id="cd:data-splitting" class="section level2">
<h2><span class="header-section-number">12.4</span> Data-splitting</h2>
<p>The extended and discussed version of the following code is presented in Chapter <a href="chvalidation.html#chvalidation">7</a>, by B. Kempen, D.J. Brus &amp; G.B.M. Heuvelink, with code contributions from G.F. Olmedo.</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb223-1" data-line-number="1"><span class="kw">library</span>(caret)</a>
<a class="sourceLine" id="cb223-2" data-line-number="2"></a>
<a class="sourceLine" id="cb223-3" data-line-number="3">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/dataproc.csv&quot;</span>)</a>
<a class="sourceLine" id="cb223-4" data-line-number="4"></a>
<a class="sourceLine" id="cb223-5" data-line-number="5">train.ind &lt;-<span class="st"> </span><span class="kw">createDataPartition</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(dat), <span class="dt">p =</span> <span class="fl">.75</span>, <span class="dt">list =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb223-6" data-line-number="6">train &lt;-<span class="st"> </span>dat[ train.ind,]</a>
<a class="sourceLine" id="cb223-7" data-line-number="7">test  &lt;-<span class="st"> </span>dat[<span class="op">-</span>train.ind,]</a>
<a class="sourceLine" id="cb223-8" data-line-number="8"></a>
<a class="sourceLine" id="cb223-9" data-line-number="9"><span class="kw">plot</span>(<span class="kw">density</span> (<span class="kw">log</span>(train<span class="op">$</span>OCSKGM)), <span class="dt">col=</span><span class="st">&#39;red&#39;</span>,</a>
<a class="sourceLine" id="cb223-10" data-line-number="10">     <span class="dt">main=</span><span class="st">&#39;Statistical distribution of train and test datasets&#39;</span>)</a>
<a class="sourceLine" id="cb223-11" data-line-number="11"><span class="kw">lines</span>(<span class="kw">density</span>(<span class="kw">log</span>(test<span class="op">$</span>OCSKGM)), <span class="dt">col=</span><span class="st">&#39;blue&#39;</span>)</a>
<a class="sourceLine" id="cb223-12" data-line-number="12"><span class="kw">legend</span>(<span class="st">&#39;topright&#39;</span>, <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">&quot;train&quot;</span>, <span class="st">&quot;test&quot;</span>),</a>
<a class="sourceLine" id="cb223-13" data-line-number="13">       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">cex=</span><span class="fl">1.5</span>)</a>
<a class="sourceLine" id="cb223-14" data-line-number="14"></a>
<a class="sourceLine" id="cb223-15" data-line-number="15"><span class="kw">write.csv</span>(train, <span class="dt">file=</span><span class="st">&quot;data/dat_train.csv&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb223-16" data-line-number="16"><span class="kw">write.csv</span>(test, <span class="dt">file=</span><span class="st">&quot;data/dat_test.csv&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>

</div>
<div id="cd:Rasterizing" class="section level2">
<h2><span class="header-section-number">12.5</span> Rasterizing a vector layer in R</h2>
<p>The extended and discussed version of the following code is presented in Chapter <a href="covariates.html#covariates">5</a>, by R. Baritz &amp; Y. Yigini.</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb224-1" data-line-number="1"><span class="kw">library</span> (raster)</a>
<a class="sourceLine" id="cb224-2" data-line-number="2">soilmap &lt;-<span class="st"> </span><span class="kw">shapefile</span>(<span class="st">&quot;MK_soilmap_simple.shp&quot;</span>)</a>
<a class="sourceLine" id="cb224-3" data-line-number="3">DEM &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;covs/DEMENV5.tif&quot;</span>)</a>
<a class="sourceLine" id="cb224-4" data-line-number="4"></a>
<a class="sourceLine" id="cb224-5" data-line-number="5"><span class="co"># the &quot;Symbol&quot; attribute from the vector layer will be used for the</span></a>
<a class="sourceLine" id="cb224-6" data-line-number="6"><span class="co"># rasterization process. It has to be a factor</span></a>
<a class="sourceLine" id="cb224-7" data-line-number="7">soilmap<span class="op">@</span>data<span class="op">$</span>Symbol &lt;-<span class="st"> </span><span class="kw">as.factor</span>(soilmap<span class="op">@</span>data<span class="op">$</span>Symbol)</a>
<a class="sourceLine" id="cb224-8" data-line-number="8"></a>
<a class="sourceLine" id="cb224-9" data-line-number="9"><span class="co">#save the levels names in a character vector</span></a>
<a class="sourceLine" id="cb224-10" data-line-number="10">Symbol.levels &lt;-<span class="st"> </span><span class="kw">levels</span>(soilmap<span class="op">$</span>Symbol)</a>
<a class="sourceLine" id="cb224-11" data-line-number="11"></a>
<a class="sourceLine" id="cb224-12" data-line-number="12"><span class="co"># The rasterization process needs a layer with the target grd</span></a>
<a class="sourceLine" id="cb224-13" data-line-number="13"><span class="co"># system: spatial extent and cell size.</span></a>
<a class="sourceLine" id="cb224-14" data-line-number="14">soilmap.r &lt;-<span class="st"> </span><span class="kw">rasterize</span>(<span class="dt">x =</span> soilmap, <span class="dt">y =</span> DEM, <span class="dt">field =</span> <span class="st">&quot;Symbol&quot;</span>)</a>
<a class="sourceLine" id="cb224-15" data-line-number="15"><span class="co"># The DEM raster layer could be used for this.</span></a>
<a class="sourceLine" id="cb224-16" data-line-number="16"></a>
<a class="sourceLine" id="cb224-17" data-line-number="17"><span class="kw">plot</span>(soilmap.r, <span class="dt">col=</span><span class="kw">rainbow</span>(<span class="dv">21</span>))</a>
<a class="sourceLine" id="cb224-18" data-line-number="18"><span class="kw">legend</span>(<span class="st">&quot;bottomright&quot;</span>,<span class="dt">legend =</span> Symbol.levels, <span class="dt">fill=</span><span class="kw">rainbow</span>(<span class="dv">21</span>),</a>
<a class="sourceLine" id="cb224-19" data-line-number="19">       <span class="dt">cex=</span><span class="fl">0.5</span>)</a></code></pre></div>

</div>
<div id="cd:Overlay" class="section level2">
<h2><span class="header-section-number">12.6</span> Overlay covariates and soil points data</h2>
<p>The extended and discussed version of the following code is presented in Chapter <a href="covariates.html#covariates">5</a>, by R. Baritz &amp; Y. Yigini.</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb225-1" data-line-number="1"><span class="co"># Load the processed data. This table was prepared in the previous</span></a>
<a class="sourceLine" id="cb225-2" data-line-number="2"><span class="co"># chapter.</span></a>
<a class="sourceLine" id="cb225-3" data-line-number="3">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/dataproc.csv&quot;</span>)</a>
<a class="sourceLine" id="cb225-4" data-line-number="4"></a>
<a class="sourceLine" id="cb225-5" data-line-number="5">files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="st">&quot;covs&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;tif$&quot;</span>,</a>
<a class="sourceLine" id="cb225-6" data-line-number="6">                    <span class="dt">full.names =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb225-7" data-line-number="7"></a>
<a class="sourceLine" id="cb225-8" data-line-number="8">covs &lt;-<span class="st"> </span><span class="kw">stack</span>(files)</a>
<a class="sourceLine" id="cb225-9" data-line-number="9"></a>
<a class="sourceLine" id="cb225-10" data-line-number="10"><span class="co">#covs &lt;- stack(covs, soilmap.r)</span></a>
<a class="sourceLine" id="cb225-11" data-line-number="11"></a>
<a class="sourceLine" id="cb225-12" data-line-number="12"><span class="co"># correct the name for layer 14</span></a>
<a class="sourceLine" id="cb225-13" data-line-number="13"><span class="co">#names(covs)[14] &lt;- &quot;soilmap&quot;</span></a>
<a class="sourceLine" id="cb225-14" data-line-number="14"></a>
<a class="sourceLine" id="cb225-15" data-line-number="15"><span class="kw">library</span> (raster)</a>
<a class="sourceLine" id="cb225-16" data-line-number="16"></a>
<a class="sourceLine" id="cb225-17" data-line-number="17"><span class="co">#mask the covariates with the country mask from the data repository</span></a>
<a class="sourceLine" id="cb225-18" data-line-number="18">mask &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;data/mask.tif&quot;</span>)</a>
<a class="sourceLine" id="cb225-19" data-line-number="19"></a>
<a class="sourceLine" id="cb225-20" data-line-number="20">covs &lt;-<span class="st"> </span><span class="kw">mask</span>(<span class="dt">x =</span> covs, <span class="dt">mask =</span> mask)</a>
<a class="sourceLine" id="cb225-21" data-line-number="21"></a>
<a class="sourceLine" id="cb225-22" data-line-number="22"><span class="co"># export all the covariates</span></a>
<a class="sourceLine" id="cb225-23" data-line-number="23"><span class="kw">save</span>(covs, <span class="dt">file =</span> <span class="st">&quot;covariates.RData&quot;</span>)</a>
<a class="sourceLine" id="cb225-24" data-line-number="24"></a>
<a class="sourceLine" id="cb225-25" data-line-number="25"><span class="kw">plot</span>(covs)</a>
<a class="sourceLine" id="cb225-26" data-line-number="26"></a>
<a class="sourceLine" id="cb225-27" data-line-number="27"><span class="co">#upgrade points data frame to SpatialPointsDataFrame</span></a>
<a class="sourceLine" id="cb225-28" data-line-number="28"><span class="kw">coordinates</span>(dat) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>Y</a>
<a class="sourceLine" id="cb225-29" data-line-number="29"></a>
<a class="sourceLine" id="cb225-30" data-line-number="30"><span class="co"># extract values from covariates to the soil points</span></a>
<a class="sourceLine" id="cb225-31" data-line-number="31">dat &lt;-<span class="st"> </span><span class="kw">extract</span>(<span class="dt">x =</span> covs, <span class="dt">y =</span> dat, <span class="dt">sp =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb225-32" data-line-number="32"></a>
<a class="sourceLine" id="cb225-33" data-line-number="33"><span class="co"># LCEE10 and soilmap are categorical variables</span></a>
<a class="sourceLine" id="cb225-34" data-line-number="34">dat<span class="op">@</span>data<span class="op">$</span>LCEE10 &lt;-<span class="st"> </span><span class="kw">as.factor</span>(dat<span class="op">@</span>data<span class="op">$</span>LCEE10)</a>
<a class="sourceLine" id="cb225-35" data-line-number="35"></a>
<a class="sourceLine" id="cb225-36" data-line-number="36"><span class="co">#dat@data$soilmap &lt;- as.factor(dat@data$soilmap)</span></a>
<a class="sourceLine" id="cb225-37" data-line-number="37"><span class="co">#levels(soilmap) &lt;- Symbol.levels</span></a>
<a class="sourceLine" id="cb225-38" data-line-number="38"></a>
<a class="sourceLine" id="cb225-39" data-line-number="39"><span class="kw">summary</span>(dat<span class="op">@</span>data)</a>
<a class="sourceLine" id="cb225-40" data-line-number="40"></a>
<a class="sourceLine" id="cb225-41" data-line-number="41">dat &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(dat)</a>
<a class="sourceLine" id="cb225-42" data-line-number="42"></a>
<a class="sourceLine" id="cb225-43" data-line-number="43"><span class="co"># The points with NA values has to be removed</span></a>
<a class="sourceLine" id="cb225-44" data-line-number="44">dat &lt;-<span class="st"> </span>dat[<span class="kw">complete.cases</span>(dat),]</a>
<a class="sourceLine" id="cb225-45" data-line-number="45"></a>
<a class="sourceLine" id="cb225-46" data-line-number="46"><span class="co"># export as a csv table</span></a>
<a class="sourceLine" id="cb225-47" data-line-number="47"><span class="kw">write.csv</span>(dat, <span class="st">&quot;data/MKD_RegMatrix.csv&quot;</span>, <span class="dt">row.names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>

</div>
<div id="cd:RK" class="section level2">
<h2><span class="header-section-number">12.7</span> Fitting a regression-kriging model to predict the SOC stock</h2>
<p>The extended and discussed version of the following code is presented in Section <a href="mappingMethods.html#RK">6.2</a>, by G.F. Olmedo &amp; Y. Yigini.</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb226-1" data-line-number="1"><span class="co"># load data</span></a>
<a class="sourceLine" id="cb226-2" data-line-number="2">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/MKD_RegMatrix.csv&quot;</span>)</a>
<a class="sourceLine" id="cb226-3" data-line-number="3"></a>
<a class="sourceLine" id="cb226-4" data-line-number="4"><span class="co"># explore the data structure</span></a>
<a class="sourceLine" id="cb226-5" data-line-number="5"><span class="kw">str</span>(dat)</a>
<a class="sourceLine" id="cb226-6" data-line-number="6"></a>
<a class="sourceLine" id="cb226-7" data-line-number="7"><span class="kw">library</span>(sp)</a>
<a class="sourceLine" id="cb226-8" data-line-number="8"></a>
<a class="sourceLine" id="cb226-9" data-line-number="9"><span class="co"># Promote to spatialPointsDataFrame</span></a>
<a class="sourceLine" id="cb226-10" data-line-number="10"><span class="kw">coordinates</span>(dat) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>Y</a>
<a class="sourceLine" id="cb226-11" data-line-number="11"></a>
<a class="sourceLine" id="cb226-12" data-line-number="12"><span class="kw">class</span>(dat)</a>
<a class="sourceLine" id="cb226-13" data-line-number="13"></a>
<a class="sourceLine" id="cb226-14" data-line-number="14">dat<span class="op">@</span>proj4string &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="dt">projargs =</span> <span class="st">&quot;+init=epsg:4326&quot;</span>)</a>
<a class="sourceLine" id="cb226-15" data-line-number="15"></a>
<a class="sourceLine" id="cb226-16" data-line-number="16">dat<span class="op">@</span>proj4string</a>
<a class="sourceLine" id="cb226-17" data-line-number="17"></a>
<a class="sourceLine" id="cb226-18" data-line-number="18"><span class="kw">library</span>(raster)</a>
<a class="sourceLine" id="cb226-19" data-line-number="19"></a>
<a class="sourceLine" id="cb226-20" data-line-number="20"><span class="kw">load</span>(<span class="dt">file =</span> <span class="st">&quot;covariates.RData&quot;</span>)</a>
<a class="sourceLine" id="cb226-21" data-line-number="21"></a>
<a class="sourceLine" id="cb226-22" data-line-number="22"><span class="kw">names</span>(covs)</a>
<a class="sourceLine" id="cb226-23" data-line-number="23"></a>
<a class="sourceLine" id="cb226-24" data-line-number="24"><span class="co"># print the names of the 14 layers:</span></a>
<a class="sourceLine" id="cb226-25" data-line-number="25"><span class="kw">names</span>(covs)</a>
<a class="sourceLine" id="cb226-26" data-line-number="26"></a>
<a class="sourceLine" id="cb226-27" data-line-number="27">datdf &lt;-<span class="st"> </span>dat<span class="op">@</span>data</a>
<a class="sourceLine" id="cb226-28" data-line-number="28"></a>
<a class="sourceLine" id="cb226-29" data-line-number="29">datdf &lt;-<span class="st"> </span>datdf[, <span class="kw">c</span>(<span class="st">&quot;OCSKGM&quot;</span>, <span class="kw">names</span>(covs))]</a>
<a class="sourceLine" id="cb226-30" data-line-number="30"></a>
<a class="sourceLine" id="cb226-31" data-line-number="31"><span class="co"># Fit a multiple linear regression model between the log transformed</span></a>
<a class="sourceLine" id="cb226-32" data-line-number="32"><span class="co"># values of OCS and the top 20 covariates</span></a>
<a class="sourceLine" id="cb226-33" data-line-number="33">model.MLR &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">log</span>(OCSKGM) <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> datdf)</a>
<a class="sourceLine" id="cb226-34" data-line-number="34"></a>
<a class="sourceLine" id="cb226-35" data-line-number="35"><span class="co"># stepwise variable selection</span></a>
<a class="sourceLine" id="cb226-36" data-line-number="36">model.MLR.step &lt;-<span class="st"> </span><span class="kw">step</span>(model.MLR, <span class="dt">direction=</span><span class="st">&quot;both&quot;</span>)</a>
<a class="sourceLine" id="cb226-37" data-line-number="37"></a>
<a class="sourceLine" id="cb226-38" data-line-number="38"><span class="co"># summary and anova of the new model using stepwise covariates</span></a>
<a class="sourceLine" id="cb226-39" data-line-number="39"><span class="co"># selection</span></a>
<a class="sourceLine" id="cb226-40" data-line-number="40"><span class="kw">summary</span>(model.MLR.step)</a>
<a class="sourceLine" id="cb226-41" data-line-number="41"><span class="kw">anova</span>(model.MLR.step)</a>
<a class="sourceLine" id="cb226-42" data-line-number="42"></a>
<a class="sourceLine" id="cb226-43" data-line-number="43"><span class="co"># graphical diagnosis of the regression analysis</span></a>
<a class="sourceLine" id="cb226-44" data-line-number="44"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb226-45" data-line-number="45"><span class="kw">plot</span>(model.MLR.step)</a>
<a class="sourceLine" id="cb226-46" data-line-number="46"><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb226-47" data-line-number="47"></a>
<a class="sourceLine" id="cb226-48" data-line-number="48"><span class="co"># collinearity test using variance inflation factors</span></a>
<a class="sourceLine" id="cb226-49" data-line-number="49"><span class="kw">library</span>(car)</a>
<a class="sourceLine" id="cb226-50" data-line-number="50"><span class="kw">vif</span>(model.MLR.step)</a>
<a class="sourceLine" id="cb226-51" data-line-number="51"></a>
<a class="sourceLine" id="cb226-52" data-line-number="52"><span class="co"># problematic covariates should have sqrt(VIF) &gt; 2</span></a>
<a class="sourceLine" id="cb226-53" data-line-number="53"><span class="kw">sqrt</span>(<span class="kw">vif</span>(model.MLR.step))</a>
<a class="sourceLine" id="cb226-54" data-line-number="54"></a>
<a class="sourceLine" id="cb226-55" data-line-number="55"><span class="co"># Removing B07CHE3 from the stepwise model:</span></a>
<a class="sourceLine" id="cb226-56" data-line-number="56">model.MLR.step &lt;-<span class="st"> </span><span class="kw">update</span>(model.MLR.step, . <span class="op">~</span><span class="st"> </span>. <span class="op">-</span><span class="st"> </span>DEMSRE3a <span class="op">-</span><span class="st"> </span>PX3WCL3a)</a>
<a class="sourceLine" id="cb226-57" data-line-number="57"></a>
<a class="sourceLine" id="cb226-58" data-line-number="58"><span class="co"># Test the vif again:</span></a>
<a class="sourceLine" id="cb226-59" data-line-number="59"><span class="kw">sqrt</span>(<span class="kw">vif</span>(model.MLR.step))</a>
<a class="sourceLine" id="cb226-60" data-line-number="60"></a>
<a class="sourceLine" id="cb226-61" data-line-number="61">## summary  of the new model using stepwise covariates selection</a>
<a class="sourceLine" id="cb226-62" data-line-number="62"><span class="kw">summary</span>(model.MLR.step)</a>
<a class="sourceLine" id="cb226-63" data-line-number="63"></a>
<a class="sourceLine" id="cb226-64" data-line-number="64"><span class="co"># outlier test using the Bonferroni test</span></a>
<a class="sourceLine" id="cb226-65" data-line-number="65"><span class="kw">outlierTest</span>(model.MLR.step)</a>
<a class="sourceLine" id="cb226-66" data-line-number="66"></a>
<a class="sourceLine" id="cb226-67" data-line-number="67"><span class="co"># Project point data.</span></a>
<a class="sourceLine" id="cb226-68" data-line-number="68">dat &lt;-<span class="st"> </span><span class="kw">spTransform</span>(dat, <span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:32648&quot;</span>))</a>
<a class="sourceLine" id="cb226-69" data-line-number="69"></a>
<a class="sourceLine" id="cb226-70" data-line-number="70"><span class="co"># project covariates to VN-2000 UTM 48N</span></a>
<a class="sourceLine" id="cb226-71" data-line-number="71">covs &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(covs, <span class="dt">crs =</span> <span class="kw">CRS</span>(<span class="st">&quot;+init=epsg:32648&quot;</span>),</a>
<a class="sourceLine" id="cb226-72" data-line-number="72">                      <span class="dt">method=</span><span class="st">&#39;ngb&#39;</span>)</a>
<a class="sourceLine" id="cb226-73" data-line-number="73"></a>
<a class="sourceLine" id="cb226-74" data-line-number="74"></a>
<a class="sourceLine" id="cb226-75" data-line-number="75"><span class="co"># Promote covariates to spatial grid dataframe. Takes some time and</span></a>
<a class="sourceLine" id="cb226-76" data-line-number="76"><span class="co"># a lot of memory!</span></a>
<a class="sourceLine" id="cb226-77" data-line-number="77">covs.sp &lt;-<span class="st"> </span><span class="kw">as</span>(covs, <span class="st">&quot;SpatialGridDataFrame&quot;</span>)</a>
<a class="sourceLine" id="cb226-78" data-line-number="78"></a>
<a class="sourceLine" id="cb226-79" data-line-number="79"><span class="co"># RK model</span></a>
<a class="sourceLine" id="cb226-80" data-line-number="80"><span class="kw">library</span>(automap)</a>
<a class="sourceLine" id="cb226-81" data-line-number="81"></a>
<a class="sourceLine" id="cb226-82" data-line-number="82"></a>
<a class="sourceLine" id="cb226-83" data-line-number="83"><span class="co"># Run regression kriging prediction. This step can take hours...!</span></a>
<a class="sourceLine" id="cb226-84" data-line-number="84">OCS.krige &lt;-<span class="st"> </span><span class="kw">autoKrige</span>(<span class="dt">formula =</span></a>
<a class="sourceLine" id="cb226-85" data-line-number="85">                         <span class="kw">as.formula</span>(model.MLR.step<span class="op">$</span>call<span class="op">$</span>formula),</a>
<a class="sourceLine" id="cb226-86" data-line-number="86">                       <span class="dt">input_data =</span> dat,</a>
<a class="sourceLine" id="cb226-87" data-line-number="87">                       <span class="dt">new_data =</span> covs.sp,</a>
<a class="sourceLine" id="cb226-88" data-line-number="88">                       <span class="dt">verbose =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb226-89" data-line-number="89">                       <span class="dt">block =</span> <span class="kw">c</span>(<span class="dv">1000</span>, <span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb226-90" data-line-number="90"></a>
<a class="sourceLine" id="cb226-91" data-line-number="91">OCS.krige</a>
<a class="sourceLine" id="cb226-92" data-line-number="92"></a>
<a class="sourceLine" id="cb226-93" data-line-number="93"><span class="co"># Convert prediction and standard deviation to rasters</span></a>
<a class="sourceLine" id="cb226-94" data-line-number="94"><span class="co"># And back-tansform the vlaues</span></a>
<a class="sourceLine" id="cb226-95" data-line-number="95">RKprediction &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">raster</span>(OCS.krige<span class="op">$</span>krige_output[<span class="dv">1</span>]))</a>
<a class="sourceLine" id="cb226-96" data-line-number="96">RKpredsd &lt;-<span class="st"> </span><span class="kw">exp</span>(<span class="kw">raster</span>(OCS.krige<span class="op">$</span>krige_output[<span class="dv">3</span>]))</a>
<a class="sourceLine" id="cb226-97" data-line-number="97"></a>
<a class="sourceLine" id="cb226-98" data-line-number="98"></a>
<a class="sourceLine" id="cb226-99" data-line-number="99"><span class="kw">plot</span>(RKprediction)</a>
<a class="sourceLine" id="cb226-100" data-line-number="100"></a>
<a class="sourceLine" id="cb226-101" data-line-number="101">## Save results as tif files</a>
<a class="sourceLine" id="cb226-102" data-line-number="102"><span class="kw">writeRaster</span>(RKprediction, <span class="dt">filename =</span> <span class="st">&quot;results/MKD_OCSKGM_RK.tif&quot;</span>,</a>
<a class="sourceLine" id="cb226-103" data-line-number="103">            <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb226-104" data-line-number="104"></a>
<a class="sourceLine" id="cb226-105" data-line-number="105"><span class="kw">writeRaster</span>(RKpredsd, <span class="dt">filename =</span> <span class="st">&quot;results/MKD_OCSKGM_RKpredsd.tif&quot;</span>,</a>
<a class="sourceLine" id="cb226-106" data-line-number="106">            <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb226-107" data-line-number="107"></a>
<a class="sourceLine" id="cb226-108" data-line-number="108"><span class="co"># save the model</span></a>
<a class="sourceLine" id="cb226-109" data-line-number="109"><span class="kw">saveRDS</span>(model.MLR.step, <span class="dt">file=</span><span class="st">&quot;results/RKmodel.Rds&quot;</span>)</a></code></pre></div>
</div>
<div id="cd:xvalRK" class="section level2">
<h2><span class="header-section-number">12.8</span> Cross-validation of regression-kriging models</h2>
<p>The extended and discussed version of the following code is presented in Section <a href="mappingMethods.html#RK">6.2</a>, by G.F. Olmedo &amp; Y. Yigini.</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb227-1" data-line-number="1"><span class="co"># autoKrige.cv() does not removes the duplicated points</span></a>
<a class="sourceLine" id="cb227-2" data-line-number="2"><span class="co"># we have to do it manually before running the cross-validation</span></a>
<a class="sourceLine" id="cb227-3" data-line-number="3">dat =<span class="st"> </span>dat[<span class="kw">which</span>(<span class="op">!</span><span class="kw">duplicated</span>(dat<span class="op">@</span>coords)), ]</a>
<a class="sourceLine" id="cb227-4" data-line-number="4"></a>
<a class="sourceLine" id="cb227-5" data-line-number="5">OCS.krige.cv &lt;-<span class="st"> </span><span class="kw">autoKrige.cv</span>(<span class="dt">formula =</span></a>
<a class="sourceLine" id="cb227-6" data-line-number="6">                               <span class="kw">as.formula</span>(model.MLR.step<span class="op">$</span>call<span class="op">$</span>formula),</a>
<a class="sourceLine" id="cb227-7" data-line-number="7">                             <span class="dt">input_data =</span> dat, <span class="dt">nfold =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb227-8" data-line-number="8"></a>
<a class="sourceLine" id="cb227-9" data-line-number="9"><span class="kw">summary</span>(OCS.krige.cv)</a></code></pre></div>

</div>
<div id="cd:rf" class="section level2">
<h2><span class="header-section-number">12.9</span> Fitting a random forest model to predict the SOC stock</h2>
<p>The extended and discussed version of the following code is presented in Section <a href="mappingMethods.html#rf">6.3</a>, by M. Guevara, C. Thine, G.F. Olmedo &amp; R.R. Vargas.</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb228-1" data-line-number="1">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/MKD_RegMatrix.csv&quot;</span>)</a>
<a class="sourceLine" id="cb228-2" data-line-number="2"></a>
<a class="sourceLine" id="cb228-3" data-line-number="3">dat<span class="op">$</span>LCEE10 &lt;-<span class="st"> </span><span class="kw">as.factor</span>(dat<span class="op">$</span>LCEE10)</a>
<a class="sourceLine" id="cb228-4" data-line-number="4"><span class="co">#dat$soilmap &lt;- as.factor(dat$soilmap)</span></a>
<a class="sourceLine" id="cb228-5" data-line-number="5"></a>
<a class="sourceLine" id="cb228-6" data-line-number="6"><span class="co"># explore the data structure</span></a>
<a class="sourceLine" id="cb228-7" data-line-number="7"><span class="kw">str</span>(dat)</a>
<a class="sourceLine" id="cb228-8" data-line-number="8"></a>
<a class="sourceLine" id="cb228-9" data-line-number="9"><span class="kw">library</span>(sp)</a>
<a class="sourceLine" id="cb228-10" data-line-number="10"></a>
<a class="sourceLine" id="cb228-11" data-line-number="11"><span class="co"># Promote to spatialPointsDataFrame</span></a>
<a class="sourceLine" id="cb228-12" data-line-number="12"><span class="kw">coordinates</span>(dat) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>Y</a>
<a class="sourceLine" id="cb228-13" data-line-number="13"></a>
<a class="sourceLine" id="cb228-14" data-line-number="14"><span class="kw">class</span>(dat)</a>
<a class="sourceLine" id="cb228-15" data-line-number="15"></a>
<a class="sourceLine" id="cb228-16" data-line-number="16">dat<span class="op">@</span>proj4string &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="dt">projargs =</span> <span class="st">&quot;+init=epsg:4326&quot;</span>)</a>
<a class="sourceLine" id="cb228-17" data-line-number="17"></a>
<a class="sourceLine" id="cb228-18" data-line-number="18">dat<span class="op">@</span>proj4string</a>
<a class="sourceLine" id="cb228-19" data-line-number="19"></a>
<a class="sourceLine" id="cb228-20" data-line-number="20"><span class="kw">load</span>(<span class="dt">file =</span> <span class="st">&quot;covariates.RData&quot;</span>)</a>
<a class="sourceLine" id="cb228-21" data-line-number="21"></a>
<a class="sourceLine" id="cb228-22" data-line-number="22"><span class="kw">names</span>(covs)</a>
<a class="sourceLine" id="cb228-23" data-line-number="23"></a>
<a class="sourceLine" id="cb228-24" data-line-number="24"><span class="co"># For its use on R we need to define a model formula</span></a>
<a class="sourceLine" id="cb228-25" data-line-number="25"></a>
<a class="sourceLine" id="cb228-26" data-line-number="26">fm =<span class="st"> </span><span class="kw">as.formula</span>(<span class="kw">paste</span>(<span class="st">&quot;log(OCSKGM) ~&quot;</span>, <span class="kw">paste0</span>(<span class="kw">names</span>(covs[[<span class="op">-</span><span class="dv">14</span>]]),</a>
<a class="sourceLine" id="cb228-27" data-line-number="27">                                              <span class="dt">collapse =</span> <span class="st">&quot;+&quot;</span>)))</a>
<a class="sourceLine" id="cb228-28" data-line-number="28"></a>
<a class="sourceLine" id="cb228-29" data-line-number="29"><span class="kw">library</span>(randomForest)</a>
<a class="sourceLine" id="cb228-30" data-line-number="30"><span class="kw">library</span>(caret)</a>
<a class="sourceLine" id="cb228-31" data-line-number="31"></a>
<a class="sourceLine" id="cb228-32" data-line-number="32"><span class="co"># Default 10-fold cross-validation</span></a>
<a class="sourceLine" id="cb228-33" data-line-number="33">ctrl &lt;-<span class="st"> </span><span class="kw">trainControl</span>(<span class="dt">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="dt">savePred=</span>T)</a>
<a class="sourceLine" id="cb228-34" data-line-number="34"><span class="co"># Search for the best mtry parameter</span></a>
<a class="sourceLine" id="cb228-35" data-line-number="35">rfmodel &lt;-<span class="st"> </span><span class="kw">train</span>(fm, <span class="dt">data=</span>dat<span class="op">@</span>data, <span class="dt">method =</span> <span class="st">&quot;rf&quot;</span>, <span class="dt">trControl =</span> ctrl,</a>
<a class="sourceLine" id="cb228-36" data-line-number="36">                 <span class="dt">importance=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb228-37" data-line-number="37"><span class="co"># This is a very useful function to compare and test different</span></a>
<a class="sourceLine" id="cb228-38" data-line-number="38"><span class="co"># prediction algorithms type names(getModelInfo()) to see all the</span></a>
<a class="sourceLine" id="cb228-39" data-line-number="39"><span class="co"># possibilitites implemented on this function</span></a>
<a class="sourceLine" id="cb228-40" data-line-number="40"></a>
<a class="sourceLine" id="cb228-41" data-line-number="41"></a>
<a class="sourceLine" id="cb228-42" data-line-number="42"><span class="co"># Variable importance plot, compare with the correlation matrix</span></a>
<a class="sourceLine" id="cb228-43" data-line-number="43"><span class="co"># Select the best prediction factors and repeat</span></a>
<a class="sourceLine" id="cb228-44" data-line-number="44"><span class="kw">varImpPlot</span>(rfmodel[<span class="dv">11</span>][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb228-45" data-line-number="45"></a>
<a class="sourceLine" id="cb228-46" data-line-number="46"><span class="co"># Check if the error stabilizes</span></a>
<a class="sourceLine" id="cb228-47" data-line-number="47"><span class="kw">plot</span>(rfmodel[<span class="dv">11</span>][[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb228-48" data-line-number="48"></a>
<a class="sourceLine" id="cb228-49" data-line-number="49"><span class="co">#Make a prediction across all Macedonia</span></a>
<a class="sourceLine" id="cb228-50" data-line-number="50"><span class="co">#Note that the units are still in log</span></a>
<a class="sourceLine" id="cb228-51" data-line-number="51">pred &lt;-<span class="st"> </span><span class="kw">predict</span>(covs, rfmodel)</a>
<a class="sourceLine" id="cb228-52" data-line-number="52"></a>
<a class="sourceLine" id="cb228-53" data-line-number="53"><span class="co"># Back transform predictions log transformed</span></a>
<a class="sourceLine" id="cb228-54" data-line-number="54">pred &lt;-<span class="st"> </span><span class="kw">exp</span>(pred)</a>
<a class="sourceLine" id="cb228-55" data-line-number="55"></a>
<a class="sourceLine" id="cb228-56" data-line-number="56"><span class="co"># Save the result as a tiff file</span></a>
<a class="sourceLine" id="cb228-57" data-line-number="57"><span class="kw">writeRaster</span>(pred, <span class="dt">filename =</span> <span class="st">&quot;results/MKD_OCSKGM_rf.tif&quot;</span>,</a>
<a class="sourceLine" id="cb228-58" data-line-number="58">            <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb228-59" data-line-number="59"></a>
<a class="sourceLine" id="cb228-60" data-line-number="60"></a>
<a class="sourceLine" id="cb228-61" data-line-number="61"><span class="kw">plot</span>(pred)</a></code></pre></div>

</div>
<div id="cd:quantreg" class="section level2">
<h2><span class="header-section-number">12.10</span> Using quantile regression forest to estimate uncertainty</h2>
<p>The extended and discussed version of the following code is presented in Section <a href="mappingMethods.html#rf">6.3</a>, by M. Guevara, C. Thine, G.F. Olmedo &amp; R.R. Vargas.</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb229-1" data-line-number="1"><span class="kw">library</span>(Metrics)</a>
<a class="sourceLine" id="cb229-2" data-line-number="2"></a>
<a class="sourceLine" id="cb229-3" data-line-number="3"><span class="co">#Generate an empty dataframe</span></a>
<a class="sourceLine" id="cb229-4" data-line-number="4">validation &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">rmse=</span><span class="kw">numeric</span>(), <span class="dt">r2=</span><span class="kw">numeric</span>())</a>
<a class="sourceLine" id="cb229-5" data-line-number="5"><span class="co">#Sensitivity to the dataset</span></a>
<a class="sourceLine" id="cb229-6" data-line-number="6"><span class="co">#Start a loop with 10 model realizations</span></a>
<a class="sourceLine" id="cb229-7" data-line-number="7"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>){</a>
<a class="sourceLine" id="cb229-8" data-line-number="8">  <span class="co"># We will build 10 models using random samples of 25%</span></a>
<a class="sourceLine" id="cb229-9" data-line-number="9">  smp_size &lt;-<span class="st"> </span><span class="kw">floor</span>(<span class="fl">0.25</span> <span class="op">*</span><span class="st"> </span><span class="kw">nrow</span>(dat))</a>
<a class="sourceLine" id="cb229-10" data-line-number="10">  train_ind &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">seq_len</span>(<span class="kw">nrow</span>(dat)), <span class="dt">size =</span> smp_size)</a>
<a class="sourceLine" id="cb229-11" data-line-number="11">  train &lt;-<span class="st"> </span>dat[train_ind, ]</a>
<a class="sourceLine" id="cb229-12" data-line-number="12">  test &lt;-<span class="st"> </span>dat[<span class="op">-</span>train_ind, ]</a>
<a class="sourceLine" id="cb229-13" data-line-number="13">  modn &lt;-<span class="st"> </span><span class="kw">train</span>(fm, <span class="dt">data=</span>train<span class="op">@</span>data, <span class="dt">method =</span> <span class="st">&quot;rf&quot;</span>, <span class="dt">trControl =</span> ctrl)</a>
<a class="sourceLine" id="cb229-14" data-line-number="14">  pred &lt;-<span class="st"> </span><span class="kw">stack</span>(pred, <span class="kw">predict</span>(covs, modn))</a>
<a class="sourceLine" id="cb229-15" data-line-number="15">  test<span class="op">$</span>pred &lt;-<span class="st"> </span><span class="kw">extract</span>(pred[[i<span class="op">+</span><span class="dv">1</span>]], test)</a>
<a class="sourceLine" id="cb229-16" data-line-number="16">  <span class="co"># Store the results in a dataframe</span></a>
<a class="sourceLine" id="cb229-17" data-line-number="17">  validation[i, <span class="dv">1</span>] &lt;-<span class="st"> </span><span class="kw">rmse</span>(<span class="kw">log</span>(test<span class="op">$</span>OCSKGM), test<span class="op">$</span>pred)</a>
<a class="sourceLine" id="cb229-18" data-line-number="18">  validation[i, <span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw">cor</span>(<span class="kw">log</span>(test<span class="op">$</span>OCSKGM), test<span class="op">$</span>pred)<span class="op">^</span><span class="dv">2</span></a>
<a class="sourceLine" id="cb229-19" data-line-number="19">}</a>
<a class="sourceLine" id="cb229-20" data-line-number="20"></a>
<a class="sourceLine" id="cb229-21" data-line-number="21"><span class="co">#The sensitivity map is the dispersion of all individual models</span></a>
<a class="sourceLine" id="cb229-22" data-line-number="22">sensitivity &lt;-<span class="st"> </span><span class="kw">calc</span>(pred[[<span class="op">-</span><span class="dv">1</span>]], sd)</a>
<a class="sourceLine" id="cb229-23" data-line-number="23"></a>
<a class="sourceLine" id="cb229-24" data-line-number="24"><span class="kw">plot</span>(sensitivity, <span class="dt">col=</span><span class="kw">rev</span>(<span class="kw">topo.colors</span>(<span class="dv">10</span>)),</a>
<a class="sourceLine" id="cb229-25" data-line-number="25">     <span class="dt">main=</span><span class="st">&#39;Sensitivity based on 10 realizations using 25% samples&#39;</span>)</a>
<a class="sourceLine" id="cb229-26" data-line-number="26"></a>
<a class="sourceLine" id="cb229-27" data-line-number="27"><span class="co">#Sensitivity of validation metrics</span></a>
<a class="sourceLine" id="cb229-28" data-line-number="28"><span class="kw">summary</span>(validation)</a>
<a class="sourceLine" id="cb229-29" data-line-number="29"></a>
<a class="sourceLine" id="cb229-30" data-line-number="30"><span class="co"># Plot of the map based on 75% of data and the sensitivity to data</span></a>
<a class="sourceLine" id="cb229-31" data-line-number="31"><span class="co"># variations</span></a>
<a class="sourceLine" id="cb229-32" data-line-number="32">prediction75 &lt;-<span class="st"> </span><span class="kw">exp</span>(pred[[<span class="dv">1</span>]])</a>
<a class="sourceLine" id="cb229-33" data-line-number="33"></a>
<a class="sourceLine" id="cb229-34" data-line-number="34"><span class="kw">plot</span>(prediction75, <span class="dt">main=</span><span class="st">&#39;OCSKGM prediction based on 75% of data&#39;</span>,</a>
<a class="sourceLine" id="cb229-35" data-line-number="35">     <span class="dt">col=</span><span class="kw">rev</span>(<span class="kw">topo.colors</span>(<span class="dv">10</span>)))</a>
<a class="sourceLine" id="cb229-36" data-line-number="36"></a>
<a class="sourceLine" id="cb229-37" data-line-number="37"><span class="co"># Use quantile regression forest to estimate the full conditional</span></a>
<a class="sourceLine" id="cb229-38" data-line-number="38"><span class="co"># distribution of OCSKGMlog, note that we are using the mtry</span></a>
<a class="sourceLine" id="cb229-39" data-line-number="39"><span class="co"># parameter that was selected by the train funtion of the caret</span></a>
<a class="sourceLine" id="cb229-40" data-line-number="40"><span class="co"># package, assuming that the 75% of data previously used well</span></a>
<a class="sourceLine" id="cb229-41" data-line-number="41"><span class="co"># resembles the statistical distribution of the entire data</span></a>
<a class="sourceLine" id="cb229-42" data-line-number="42"><span class="co"># population. Otherwise repeat the train function with all available</span></a>
<a class="sourceLine" id="cb229-43" data-line-number="43"><span class="co">#data (using the object dat that instead of train) to select mtry.</span></a>
<a class="sourceLine" id="cb229-44" data-line-number="44"></a>
<a class="sourceLine" id="cb229-45" data-line-number="45"><span class="kw">library</span>(quantregForest)</a>
<a class="sourceLine" id="cb229-46" data-line-number="46"></a>
<a class="sourceLine" id="cb229-47" data-line-number="47">model &lt;-<span class="st"> </span><span class="kw">quantregForest</span>(<span class="dt">y=</span><span class="kw">log</span>(dat<span class="op">@</span>data<span class="op">$</span>OCSKGM), <span class="dt">x=</span>dat<span class="op">@</span>data[,<span class="dv">8</span><span class="op">:</span><span class="dv">20</span>], <span class="dt">ntree=</span><span class="dv">500</span>,</a>
<a class="sourceLine" id="cb229-48" data-line-number="48">                        <span class="dt">keep.inbag=</span><span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb229-49" data-line-number="49">                        <span class="dt">mtry =</span> <span class="kw">as.numeric</span>(modn<span class="op">$</span>bestTune))</a>
<a class="sourceLine" id="cb229-50" data-line-number="50"></a>
<a class="sourceLine" id="cb229-51" data-line-number="51"><span class="kw">library</span>(snow)</a>
<a class="sourceLine" id="cb229-52" data-line-number="52"><span class="co"># Estimate model uncertainty at the pixel level using parallel</span></a>
<a class="sourceLine" id="cb229-53" data-line-number="53"><span class="co"># computing</span></a>
<a class="sourceLine" id="cb229-54" data-line-number="54"><span class="kw">beginCluster</span>() <span class="co">#define number of cores to use</span></a>
<a class="sourceLine" id="cb229-55" data-line-number="55"><span class="co"># Estimate model uncertainty</span></a>
<a class="sourceLine" id="cb229-56" data-line-number="56">unc &lt;-<span class="st"> </span><span class="kw">clusterR</span>(covs, predict, <span class="dt">args=</span><span class="kw">list</span>(<span class="dt">model=</span>model,<span class="dt">what=</span>sd))</a>
<a class="sourceLine" id="cb229-57" data-line-number="57"><span class="co"># OCSKGMlog prediction based in all available data</span></a>
<a class="sourceLine" id="cb229-58" data-line-number="58">mean &lt;-<span class="st"> </span><span class="kw">clusterR</span>(covs, predict,</a>
<a class="sourceLine" id="cb229-59" data-line-number="59">                 <span class="dt">args=</span><span class="kw">list</span>(<span class="dt">model=</span>model, <span class="dt">what=</span>mean))</a>
<a class="sourceLine" id="cb229-60" data-line-number="60"><span class="co"># The total uncertainty is the sum of sensitivity and model</span></a>
<a class="sourceLine" id="cb229-61" data-line-number="61"><span class="co"># uncertainty</span></a>
<a class="sourceLine" id="cb229-62" data-line-number="62">unc &lt;-<span class="st"> </span>unc <span class="op">+</span><span class="st"> </span>sensitivity</a>
<a class="sourceLine" id="cb229-63" data-line-number="63"><span class="co"># Express the uncertainty in percent (divide by the mean)</span></a>
<a class="sourceLine" id="cb229-64" data-line-number="64">Total_unc_Percent &lt;-<span class="st"> </span><span class="kw">exp</span>(unc)<span class="op">/</span><span class="kw">exp</span>(mean)</a>
<a class="sourceLine" id="cb229-65" data-line-number="65"><span class="kw">endCluster</span>()</a>
<a class="sourceLine" id="cb229-66" data-line-number="66"></a>
<a class="sourceLine" id="cb229-67" data-line-number="67"><span class="co"># Plot both maps (the predicted OCSKGM + its associated uncertainty)</span></a>
<a class="sourceLine" id="cb229-68" data-line-number="68"><span class="kw">plot</span>(<span class="kw">exp</span>(mean), <span class="dt">main=</span><span class="st">&#39;OCSKGM based in all data&#39;</span>,</a>
<a class="sourceLine" id="cb229-69" data-line-number="69">     <span class="dt">col=</span><span class="kw">rev</span>(<span class="kw">topo.colors</span>(<span class="dv">10</span>)))</a>
<a class="sourceLine" id="cb229-70" data-line-number="70"></a>
<a class="sourceLine" id="cb229-71" data-line-number="71"><span class="kw">plot</span>(Total_unc_Percent, <span class="dt">col=</span><span class="kw">rev</span>(<span class="kw">heat.colors</span>(<span class="dv">100</span>)), <span class="dt">zlim=</span><span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">5</span>),</a>
<a class="sourceLine" id="cb229-72" data-line-number="72">     <span class="dt">main=</span><span class="st">&#39;Total uncertainty&#39;</span>)</a>
<a class="sourceLine" id="cb229-73" data-line-number="73"></a>
<a class="sourceLine" id="cb229-74" data-line-number="74"><span class="co">#Save the resulting maps in separated *.tif files</span></a>
<a class="sourceLine" id="cb229-75" data-line-number="75"><span class="kw">writeRaster</span>(<span class="kw">exp</span>(mean), <span class="dt">file=</span><span class="st">&#39;rfOCSKGMprediction.tif&#39;</span>,</a>
<a class="sourceLine" id="cb229-76" data-line-number="76">            <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb229-77" data-line-number="77"><span class="kw">writeRaster</span>(Total_unc_Percent, <span class="dt">file=</span><span class="st">&#39;rfOCSKGMtotalUncertPercent.tif&#39;</span>,</a>
<a class="sourceLine" id="cb229-78" data-line-number="78">            <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a></code></pre></div>

</div>
<div id="cd:svm" class="section level2">
<h2><span class="header-section-number">12.11</span> Fitting a support vector machines model to predict the SOC stock</h2>
<p>The extended and discussed version of the following code is presented in Section <a href="mappingMethods.html#svm">6.4</a>, by G.F. Olmedo &amp; M. Guevara.</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb230-1" data-line-number="1"><span class="co"># load data</span></a>
<a class="sourceLine" id="cb230-2" data-line-number="2">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/MKD_RegMatrix.csv&quot;</span>)</a>
<a class="sourceLine" id="cb230-3" data-line-number="3"></a>
<a class="sourceLine" id="cb230-4" data-line-number="4">dat<span class="op">$</span>LCEE10 &lt;-<span class="st"> </span><span class="kw">as.factor</span>(dat<span class="op">$</span>LCEE10)</a>
<a class="sourceLine" id="cb230-5" data-line-number="5"><span class="co"># dat$soilmap &lt;- as.factor(dat$soilmap)</span></a>
<a class="sourceLine" id="cb230-6" data-line-number="6"></a>
<a class="sourceLine" id="cb230-7" data-line-number="7"><span class="co"># explore the data structure</span></a>
<a class="sourceLine" id="cb230-8" data-line-number="8"><span class="kw">str</span>(dat)</a>
<a class="sourceLine" id="cb230-9" data-line-number="9"></a>
<a class="sourceLine" id="cb230-10" data-line-number="10"><span class="kw">library</span>(sp)</a>
<a class="sourceLine" id="cb230-11" data-line-number="11"></a>
<a class="sourceLine" id="cb230-12" data-line-number="12"><span class="co"># Promote to spatialPointsDataFrame</span></a>
<a class="sourceLine" id="cb230-13" data-line-number="13"><span class="kw">coordinates</span>(dat) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>Y</a>
<a class="sourceLine" id="cb230-14" data-line-number="14"></a>
<a class="sourceLine" id="cb230-15" data-line-number="15"><span class="kw">class</span>(dat)</a>
<a class="sourceLine" id="cb230-16" data-line-number="16"></a>
<a class="sourceLine" id="cb230-17" data-line-number="17">dat<span class="op">@</span>proj4string &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="dt">projargs =</span> <span class="st">&quot;+init=epsg:4326&quot;</span>)</a>
<a class="sourceLine" id="cb230-18" data-line-number="18"></a>
<a class="sourceLine" id="cb230-19" data-line-number="19">dat<span class="op">@</span>proj4string</a>
<a class="sourceLine" id="cb230-20" data-line-number="20"></a>
<a class="sourceLine" id="cb230-21" data-line-number="21"><span class="kw">load</span>(<span class="dt">file =</span> <span class="st">&quot;covariates.RData&quot;</span>)</a>
<a class="sourceLine" id="cb230-22" data-line-number="22"></a>
<a class="sourceLine" id="cb230-23" data-line-number="23"><span class="kw">names</span>(covs)</a>
<a class="sourceLine" id="cb230-24" data-line-number="24"></a>
<a class="sourceLine" id="cb230-25" data-line-number="25"><span class="co"># plot the names of the covariates</span></a>
<a class="sourceLine" id="cb230-26" data-line-number="26"><span class="kw">names</span>(dat<span class="op">@</span>data)</a>
<a class="sourceLine" id="cb230-27" data-line-number="27"></a>
<a class="sourceLine" id="cb230-28" data-line-number="28"><span class="co"># variable selection using correlation analysis</span></a>
<a class="sourceLine" id="cb230-29" data-line-number="29">selectedCovs &lt;-<span class="st"> </span><span class="kw">cor</span>(<span class="dt">x =</span> <span class="kw">as.matrix</span>(dat<span class="op">@</span>data[,<span class="dv">5</span>]),</a>
<a class="sourceLine" id="cb230-30" data-line-number="30">                    <span class="dt">y =</span> <span class="kw">as.matrix</span>(dat<span class="op">@</span>data[,<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">7</span>,<span class="dv">13</span>,<span class="dv">21</span>)]))</a>
<a class="sourceLine" id="cb230-31" data-line-number="31"></a>
<a class="sourceLine" id="cb230-32" data-line-number="32"><span class="co"># print correlation results</span></a>
<a class="sourceLine" id="cb230-33" data-line-number="33">selectedCovs</a>
<a class="sourceLine" id="cb230-34" data-line-number="34"></a>
<a class="sourceLine" id="cb230-35" data-line-number="35"><span class="kw">library</span>(reshape)</a>
<a class="sourceLine" id="cb230-36" data-line-number="36">x &lt;-<span class="st"> </span><span class="kw">subset</span>(<span class="kw">melt</span>(selectedCovs), value <span class="op">!=</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>value <span class="op">!=</span><span class="st"> </span><span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb230-37" data-line-number="37">x &lt;-<span class="st"> </span>x[<span class="kw">with</span>(x, <span class="kw">order</span>(<span class="op">-</span><span class="kw">abs</span>(x<span class="op">$</span>value))),]</a>
<a class="sourceLine" id="cb230-38" data-line-number="38"></a>
<a class="sourceLine" id="cb230-39" data-line-number="39">idx &lt;-<span class="st"> </span><span class="kw">as.character</span>(x<span class="op">$</span>X2[<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>])</a>
<a class="sourceLine" id="cb230-40" data-line-number="40"></a>
<a class="sourceLine" id="cb230-41" data-line-number="41">dat2 &lt;-<span class="st"> </span>dat[<span class="kw">c</span>(<span class="st">&#39;OCSKGM&#39;</span>, idx)]</a>
<a class="sourceLine" id="cb230-42" data-line-number="42"><span class="kw">names</span>(dat2)</a>
<a class="sourceLine" id="cb230-43" data-line-number="43"></a>
<a class="sourceLine" id="cb230-44" data-line-number="44">COV &lt;-<span class="st"> </span>covs[[idx]]</a>
<a class="sourceLine" id="cb230-45" data-line-number="45"></a>
<a class="sourceLine" id="cb230-46" data-line-number="46"><span class="co"># Selected covariates</span></a>
<a class="sourceLine" id="cb230-47" data-line-number="47"><span class="kw">names</span>(COV)</a>
<a class="sourceLine" id="cb230-48" data-line-number="48"></a>
<a class="sourceLine" id="cb230-49" data-line-number="49"></a>
<a class="sourceLine" id="cb230-50" data-line-number="50"><span class="co"># Categorical variables in svm models</span></a>
<a class="sourceLine" id="cb230-51" data-line-number="51">dummyRaster &lt;-<span class="st"> </span><span class="cf">function</span>(rast){</a>
<a class="sourceLine" id="cb230-52" data-line-number="52">  rast &lt;-<span class="st"> </span><span class="kw">as.factor</span>(rast)</a>
<a class="sourceLine" id="cb230-53" data-line-number="53">  result &lt;-<span class="st"> </span><span class="kw">list</span>()</a>
<a class="sourceLine" id="cb230-54" data-line-number="54">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(<span class="kw">levels</span>(rast)[[<span class="dv">1</span>]][[<span class="dv">1</span>]])){</a>
<a class="sourceLine" id="cb230-55" data-line-number="55">    result[[i]] &lt;-<span class="st"> </span>rast <span class="op">==</span><span class="st"> </span><span class="kw">levels</span>(rast)[[<span class="dv">1</span>]][[<span class="dv">1</span>]][i]</a>
<a class="sourceLine" id="cb230-56" data-line-number="56">    <span class="kw">names</span>(result[[i]]) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">names</span>(rast),</a>
<a class="sourceLine" id="cb230-57" data-line-number="57">                                 <span class="kw">levels</span>(rast)[[<span class="dv">1</span>]][[<span class="dv">1</span>]][i])</a>
<a class="sourceLine" id="cb230-58" data-line-number="58">  }</a>
<a class="sourceLine" id="cb230-59" data-line-number="59">  <span class="kw">return</span>(<span class="kw">stack</span>(result))</a>
<a class="sourceLine" id="cb230-60" data-line-number="60">}</a>
<a class="sourceLine" id="cb230-61" data-line-number="61"></a>
<a class="sourceLine" id="cb230-62" data-line-number="62"><span class="co"># convert soilmap from factor to dummy</span></a>
<a class="sourceLine" id="cb230-63" data-line-number="63"><span class="co"># soilmap_dummy &lt;- dummyRaster(covs$soilmap)</span></a>
<a class="sourceLine" id="cb230-64" data-line-number="64"></a>
<a class="sourceLine" id="cb230-65" data-line-number="65"><span class="co"># convert LCEE10 from factor to dummy</span></a>
<a class="sourceLine" id="cb230-66" data-line-number="66">LCEE10_dummy &lt;-<span class="st"> </span><span class="kw">dummyRaster</span>(covs<span class="op">$</span>LCEE10)</a>
<a class="sourceLine" id="cb230-67" data-line-number="67"></a>
<a class="sourceLine" id="cb230-68" data-line-number="68"><span class="co"># Stack the 5 COV layers with the 2 dummies</span></a>
<a class="sourceLine" id="cb230-69" data-line-number="69">COV &lt;-<span class="st"> </span><span class="kw">stack</span>(COV, LCEE10_dummy)</a>
<a class="sourceLine" id="cb230-70" data-line-number="70"><span class="co"># COV &lt;- stack(COV, soilmap_dummy, LCEE10_dummy)</span></a>
<a class="sourceLine" id="cb230-71" data-line-number="71"></a>
<a class="sourceLine" id="cb230-72" data-line-number="72"><span class="co"># print the final layer names</span></a>
<a class="sourceLine" id="cb230-73" data-line-number="73"><span class="kw">names</span>(COV)</a>
<a class="sourceLine" id="cb230-74" data-line-number="74"></a>
<a class="sourceLine" id="cb230-75" data-line-number="75"><span class="co"># convert soilmap column to dummy, the result is a matrix</span></a>
<a class="sourceLine" id="cb230-76" data-line-number="76"><span class="co"># to have one column per category we had to add -1 to the formula</span></a>
<a class="sourceLine" id="cb230-77" data-line-number="77"><span class="co"># dat_soilmap_dummy &lt;- model.matrix(~soilmap -1, data = dat@data)</span></a>
<a class="sourceLine" id="cb230-78" data-line-number="78"><span class="co"># convert the matrix to a data.frame</span></a>
<a class="sourceLine" id="cb230-79" data-line-number="79"><span class="co"># dat_soilmap_dummy &lt;- as.data.frame(dat_soilmap_dummy)</span></a>
<a class="sourceLine" id="cb230-80" data-line-number="80"></a>
<a class="sourceLine" id="cb230-81" data-line-number="81"></a>
<a class="sourceLine" id="cb230-82" data-line-number="82"><span class="co"># convert LCEE10 column to dummy, the result is a matrix</span></a>
<a class="sourceLine" id="cb230-83" data-line-number="83"><span class="co"># to have one column per category we had to add -1 to the formula</span></a>
<a class="sourceLine" id="cb230-84" data-line-number="84">dat_LCEE10_dummy &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>LCEE10 <span class="dv">-1</span>, <span class="dt">data =</span> dat<span class="op">@</span>data)</a>
<a class="sourceLine" id="cb230-85" data-line-number="85"><span class="co"># convert the matrix to a data.frame</span></a>
<a class="sourceLine" id="cb230-86" data-line-number="86">dat_LCEE10_dummy &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(dat_LCEE10_dummy)</a>
<a class="sourceLine" id="cb230-87" data-line-number="87"></a>
<a class="sourceLine" id="cb230-88" data-line-number="88">dat<span class="op">@</span>data &lt;-<span class="st"> </span><span class="kw">cbind</span>(dat<span class="op">@</span>data, dat_LCEE10_dummy)</a>
<a class="sourceLine" id="cb230-89" data-line-number="89"><span class="co"># dat@data &lt;- cbind(dat@data, dat_LCEE10_dummy, dat_soilmap_dummy)</span></a>
<a class="sourceLine" id="cb230-90" data-line-number="90"></a>
<a class="sourceLine" id="cb230-91" data-line-number="91"><span class="kw">names</span>(dat<span class="op">@</span>data)</a>
<a class="sourceLine" id="cb230-92" data-line-number="92"></a>
<a class="sourceLine" id="cb230-93" data-line-number="93"><span class="co"># Fitting a svm model and parameter tuning</span></a>
<a class="sourceLine" id="cb230-94" data-line-number="94"><span class="kw">library</span>(e1071)</a>
<a class="sourceLine" id="cb230-95" data-line-number="95"><span class="kw">library</span>(caret)</a>
<a class="sourceLine" id="cb230-96" data-line-number="96"></a>
<a class="sourceLine" id="cb230-97" data-line-number="97"><span class="co">#  Test different values of epsilon and cost</span></a>
<a class="sourceLine" id="cb230-98" data-line-number="98">tuneResult &lt;-<span class="st"> </span><span class="kw">tune</span>(svm, OCSKGM <span class="op">~</span>.,  <span class="dt">data =</span> dat<span class="op">@</span>data[,<span class="kw">c</span>(<span class="st">&quot;OCSKGM&quot;</span>,</a>
<a class="sourceLine" id="cb230-99" data-line-number="99">                                                       <span class="kw">names</span>(COV))],</a>
<a class="sourceLine" id="cb230-100" data-line-number="100">                   <span class="dt">ranges =</span> <span class="kw">list</span>(<span class="dt">epsilon =</span> <span class="kw">seq</span>(<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.02</span>),</a>
<a class="sourceLine" id="cb230-101" data-line-number="101">                                 <span class="dt">cost =</span> <span class="kw">c</span>(<span class="dv">5</span>,<span class="dv">7</span>,<span class="dv">15</span>,<span class="dv">20</span>)))</a>
<a class="sourceLine" id="cb230-102" data-line-number="102"></a>
<a class="sourceLine" id="cb230-103" data-line-number="103"></a>
<a class="sourceLine" id="cb230-104" data-line-number="104"><span class="kw">plot</span>(tuneResult)</a>
<a class="sourceLine" id="cb230-105" data-line-number="105"></a>
<a class="sourceLine" id="cb230-106" data-line-number="106"><span class="co"># Choose the model with the best combination of epsilon and cost</span></a>
<a class="sourceLine" id="cb230-107" data-line-number="107">tunedModel &lt;-<span class="st"> </span>tuneResult<span class="op">$</span>best.model</a>
<a class="sourceLine" id="cb230-108" data-line-number="108"></a>
<a class="sourceLine" id="cb230-109" data-line-number="109"><span class="kw">print</span>(tunedModel)</a>
<a class="sourceLine" id="cb230-110" data-line-number="110"></a>
<a class="sourceLine" id="cb230-111" data-line-number="111"></a>
<a class="sourceLine" id="cb230-112" data-line-number="112"><span class="co"># Use the model to predict the SOC in the covariates space</span></a>
<a class="sourceLine" id="cb230-113" data-line-number="113">OCSsvm &lt;-<span class="st"> </span><span class="kw">predict</span>(COV, tunedModel)</a>
<a class="sourceLine" id="cb230-114" data-line-number="114"></a>
<a class="sourceLine" id="cb230-115" data-line-number="115"><span class="co"># Save the result</span></a>
<a class="sourceLine" id="cb230-116" data-line-number="116"><span class="kw">writeRaster</span>(OCSsvm, <span class="dt">filename =</span> <span class="st">&quot;results/MKD_OCSKGM_svm.tif&quot;</span>,</a>
<a class="sourceLine" id="cb230-117" data-line-number="117">            <span class="dt">overwrite=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb230-118" data-line-number="118"></a>
<a class="sourceLine" id="cb230-119" data-line-number="119"><span class="kw">plot</span>(OCSsvm)</a>
<a class="sourceLine" id="cb230-120" data-line-number="120"></a>
<a class="sourceLine" id="cb230-121" data-line-number="121"><span class="co"># Variable importance in svm. Code by:</span></a>
<a class="sourceLine" id="cb230-122" data-line-number="122"><span class="co"># stackoverflow.com/questions/34781495</span></a>
<a class="sourceLine" id="cb230-123" data-line-number="123"></a>
<a class="sourceLine" id="cb230-124" data-line-number="124">w &lt;-<span class="st"> </span><span class="kw">t</span>(tunedModel<span class="op">$</span>coefs) <span class="op">%*%</span><span class="st"> </span>tunedModel<span class="op">$</span>SV     <span class="co"># weight vectors</span></a>
<a class="sourceLine" id="cb230-125" data-line-number="125">w &lt;-<span class="st"> </span><span class="kw">apply</span>(w, <span class="dv">2</span>, <span class="cf">function</span>(v){<span class="kw">sqrt</span>(<span class="kw">sum</span>(v<span class="op">^</span><span class="dv">2</span>))})  <span class="co"># weight</span></a>
<a class="sourceLine" id="cb230-126" data-line-number="126"></a>
<a class="sourceLine" id="cb230-127" data-line-number="127">w &lt;-<span class="st"> </span><span class="kw">sort</span>(w, <span class="dt">decreasing =</span> T)</a>
<a class="sourceLine" id="cb230-128" data-line-number="128"><span class="kw">print</span>(w)</a></code></pre></div>

</div>
<div id="cd:Validation" class="section level2">
<h2><span class="header-section-number">12.12</span> Validation</h2>
<p>The extended and discussed version of the following code is presented in Chapter <a href="chvalidation.html#chvalidation">7</a>, by B. Kempen, D.J. Brus &amp; G.B.M. Heuvelink, with code contributions from G.F. Olmedo.</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb231-1" data-line-number="1">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;data/dat_test.csv&quot;</span>)</a>
<a class="sourceLine" id="cb231-2" data-line-number="2"></a>
<a class="sourceLine" id="cb231-3" data-line-number="3"><span class="kw">library</span>(sp)</a>
<a class="sourceLine" id="cb231-4" data-line-number="4"></a>
<a class="sourceLine" id="cb231-5" data-line-number="5"><span class="co"># Promote to spatialPointsDataFrame</span></a>
<a class="sourceLine" id="cb231-6" data-line-number="6"><span class="kw">coordinates</span>(dat) &lt;-<span class="st"> </span><span class="er">~</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>Y</a>
<a class="sourceLine" id="cb231-7" data-line-number="7"></a>
<a class="sourceLine" id="cb231-8" data-line-number="8">dat<span class="op">@</span>proj4string &lt;-<span class="st"> </span><span class="kw">CRS</span>(<span class="dt">projargs =</span> <span class="st">&quot;+init=epsg:4326&quot;</span>)</a>
<a class="sourceLine" id="cb231-9" data-line-number="9"></a>
<a class="sourceLine" id="cb231-10" data-line-number="10"><span class="kw">library</span>(raster)</a>
<a class="sourceLine" id="cb231-11" data-line-number="11"></a>
<a class="sourceLine" id="cb231-12" data-line-number="12">OCSKGM_rf &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="st">&quot;results/MKD_OCSKGM_rf.tif&quot;</span>)</a>
<a class="sourceLine" id="cb231-13" data-line-number="13"></a>
<a class="sourceLine" id="cb231-14" data-line-number="14">dat &lt;-<span class="st"> </span><span class="kw">extract</span>(<span class="dt">x =</span> OCSKGM_rf, <span class="dt">y =</span> dat, <span class="dt">sp =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb231-15" data-line-number="15"></a>
<a class="sourceLine" id="cb231-16" data-line-number="16"><span class="co"># prediction error</span></a>
<a class="sourceLine" id="cb231-17" data-line-number="17">dat<span class="op">$</span>PE_rf &lt;-<span class="st"> </span>dat<span class="op">$</span>MKD_OCSKGM_rf <span class="op">-</span><span class="st"> </span>dat<span class="op">$</span>OCSKGM</a>
<a class="sourceLine" id="cb231-18" data-line-number="18"></a>
<a class="sourceLine" id="cb231-19" data-line-number="19"><span class="co"># Mean Error</span></a>
<a class="sourceLine" id="cb231-20" data-line-number="20">ME_rf &lt;-<span class="st"> </span><span class="kw">mean</span>(dat<span class="op">$</span>PE_rf, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb231-21" data-line-number="21"></a>
<a class="sourceLine" id="cb231-22" data-line-number="22"><span class="co"># Mean Absolute Error (MAE)</span></a>
<a class="sourceLine" id="cb231-23" data-line-number="23">MAE_rf &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">abs</span>(dat<span class="op">$</span>PE_rf), <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb231-24" data-line-number="24"></a>
<a class="sourceLine" id="cb231-25" data-line-number="25"><span class="co"># Mean Squared Error (MSE)</span></a>
<a class="sourceLine" id="cb231-26" data-line-number="26">MSE_rf &lt;-<span class="st"> </span><span class="kw">mean</span>(dat<span class="op">$</span>PE_rf<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb231-27" data-line-number="27"></a>
<a class="sourceLine" id="cb231-28" data-line-number="28"><span class="co"># Root Mean Squared Error (RMSE)</span></a>
<a class="sourceLine" id="cb231-29" data-line-number="29">RMSE_rf &lt;-<span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">sum</span>(dat<span class="op">$</span>PE_rf<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">/</span><span class="st"> </span><span class="kw">length</span>(dat<span class="op">$</span>PE_rf))</a>
<a class="sourceLine" id="cb231-30" data-line-number="30"></a>
<a class="sourceLine" id="cb231-31" data-line-number="31"><span class="co"># Amount of Variance Explained (AVE)</span></a>
<a class="sourceLine" id="cb231-32" data-line-number="32">AVE_rf &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(dat<span class="op">$</span>PE_rf<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>) <span class="op">/</span></a>
<a class="sourceLine" id="cb231-33" data-line-number="33"><span class="st">  </span><span class="kw">sum</span>( (dat<span class="op">$</span>OCSKGM <span class="op">-</span><span class="st"> </span><span class="kw">mean</span>(dat<span class="op">$</span>OCSKGM, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))<span class="op">^</span><span class="dv">2</span>,</a>
<a class="sourceLine" id="cb231-34" data-line-number="34">       <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a></code></pre></div>

</div>
<div id="cd:Graphs" class="section level2">
<h2><span class="header-section-number">12.13</span> Graphical map quality measures</h2>
<p>The extended and discussed version of the following code is presented in Chapter <a href="chvalidation.html#chvalidation">7</a>, by B. Kempen, D.J. Brus &amp; G.B.M. Heuvelink, with code contributions from G.F. Olmedo.</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb232-1" data-line-number="1"><span class="co"># scatter plot</span></a>
<a class="sourceLine" id="cb232-2" data-line-number="2"><span class="kw">plot</span>(dat<span class="op">$</span>MKD_OCSKGM_rf, dat<span class="op">$</span>OCSKGM, <span class="dt">main=</span><span class="st">&quot;rf&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;predicted&quot;</span>,</a>
<a class="sourceLine" id="cb232-3" data-line-number="3">     <span class="dt">ylab=</span><span class="st">&#39;observed&#39;</span>)</a>
<a class="sourceLine" id="cb232-4" data-line-number="4"><span class="co"># 1:1 line in black</span></a>
<a class="sourceLine" id="cb232-5" data-line-number="5"><span class="kw">abline</span>(<span class="dv">0</span>,<span class="dv">1</span>, <span class="dt">lty=</span><span class="dv">2</span>, <span class="dt">col=</span><span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb232-6" data-line-number="6"><span class="co"># regression line between predicted and observed in blue</span></a>
<a class="sourceLine" id="cb232-7" data-line-number="7"><span class="kw">abline</span>(<span class="kw">lm</span>(dat<span class="op">$</span>OCSKGM <span class="op">~</span><span class="st"> </span>dat<span class="op">$</span>MKD_OCSKGM_rf), <span class="dt">col =</span> <span class="st">&#39;blue&#39;</span>, <span class="dt">lty=</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb232-8" data-line-number="8"></a>
<a class="sourceLine" id="cb232-9" data-line-number="9"><span class="co"># spatial bubbles for prediction errors</span></a>
<a class="sourceLine" id="cb232-10" data-line-number="10"><span class="kw">bubble</span>(dat[<span class="op">!</span><span class="kw">is.na</span>(dat<span class="op">$</span>PE_rf),], <span class="st">&quot;PE_rf&quot;</span>, <span class="dt">pch =</span> <span class="dv">21</span>,</a>
<a class="sourceLine" id="cb232-11" data-line-number="11">       <span class="dt">col=</span><span class="kw">c</span>(<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>))</a></code></pre></div>

</div>
<div id="cd:Evaluation" class="section level2">
<h2><span class="header-section-number">12.14</span> Model evaluation</h2>
<p>The extended and discussed version of the following code is presented in Chapter <a href="evaluation.html#evaluation">8</a>, by M. Guevara and G.F. Olmedo.</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb233-1" data-line-number="1"><span class="kw">library</span>(raster)</a>
<a class="sourceLine" id="cb233-2" data-line-number="2">RF&lt;-<span class="kw">raster</span>(<span class="st">&#39;results/MKD_OCSKGM_rf.tif&#39;</span>)</a>
<a class="sourceLine" id="cb233-3" data-line-number="3">RK&lt;-<span class="kw">raster</span>(<span class="st">&#39;results/MKD_OCSKGM_RK.tif&#39;</span>)</a>
<a class="sourceLine" id="cb233-4" data-line-number="4">SVM&lt;-<span class="kw">raster</span>(<span class="st">&#39;results/MKD_OCSKGM_svm.tif&#39;</span>)</a>
<a class="sourceLine" id="cb233-5" data-line-number="5"><span class="co">#Note that RK has a different reference system</span></a>
<a class="sourceLine" id="cb233-6" data-line-number="6">RK &lt;-<span class="st"> </span><span class="kw">projectRaster</span>(RK, SVM)</a>
<a class="sourceLine" id="cb233-7" data-line-number="7">models &lt;-<span class="st"> </span><span class="kw">stack</span>(RK, RF, SVM)</a>
<a class="sourceLine" id="cb233-8" data-line-number="8"></a>
<a class="sourceLine" id="cb233-9" data-line-number="9"><span class="kw">library</span>(psych)</a>
<a class="sourceLine" id="cb233-10" data-line-number="10"><span class="kw">pairs.panels</span>(<span class="kw">na.omit</span>(<span class="kw">as.data.frame</span>(models)),</a>
<a class="sourceLine" id="cb233-11" data-line-number="11">             <span class="dt">method =</span> <span class="st">&quot;pearson&quot;</span>, <span class="co"># correlation method</span></a>
<a class="sourceLine" id="cb233-12" data-line-number="12">             <span class="dt">hist.col =</span> <span class="st">&quot;#00AFBB&quot;</span>,</a>
<a class="sourceLine" id="cb233-13" data-line-number="13">             <span class="dt">density =</span> <span class="ot">TRUE</span>,  <span class="co"># show density plots</span></a>
<a class="sourceLine" id="cb233-14" data-line-number="14">             <span class="dt">ellipses =</span> <span class="ot">TRUE</span> <span class="co"># show correlation ellipses</span></a>
<a class="sourceLine" id="cb233-15" data-line-number="15">)</a>
<a class="sourceLine" id="cb233-16" data-line-number="16"></a>
<a class="sourceLine" id="cb233-17" data-line-number="17"></a>
<a class="sourceLine" id="cb233-18" data-line-number="18"><span class="kw">library</span>(rasterVis)</a>
<a class="sourceLine" id="cb233-19" data-line-number="19"><span class="kw">densityplot</span>(models)</a>
<a class="sourceLine" id="cb233-20" data-line-number="20"></a>
<a class="sourceLine" id="cb233-21" data-line-number="21">SD &lt;-<span class="st"> </span><span class="kw">calc</span>(models , sd)</a>
<a class="sourceLine" id="cb233-22" data-line-number="22"><span class="kw">library</span>(mapview)</a>
<a class="sourceLine" id="cb233-23" data-line-number="23"><span class="kw">mapview</span>(SD)</a>
<a class="sourceLine" id="cb233-24" data-line-number="24"></a>
<a class="sourceLine" id="cb233-25" data-line-number="25">RKRF  &lt;-<span class="st"> </span><span class="kw">calc</span>(models[[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)]], diff)</a>
<a class="sourceLine" id="cb233-26" data-line-number="26">RKSVM &lt;-<span class="st"> </span><span class="kw">calc</span>(models[[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)]], diff)</a>
<a class="sourceLine" id="cb233-27" data-line-number="27">RFSVM &lt;-<span class="st"> </span><span class="kw">calc</span>(models[[<span class="kw">c</span>(<span class="dv">2</span>,<span class="dv">3</span>)]], diff)</a>
<a class="sourceLine" id="cb233-28" data-line-number="28">preds &lt;-<span class="st"> </span><span class="kw">stack</span>(RKRF, RKSVM, RFSVM)</a>
<a class="sourceLine" id="cb233-29" data-line-number="29"><span class="kw">names</span>(preds) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;RKvsRF&#39;</span>,<span class="st">&#39;RKvsSVM&#39;</span>,<span class="st">&#39;RFvsSVM&#39;</span>)</a>
<a class="sourceLine" id="cb233-30" data-line-number="30">X &lt;-<span class="st"> </span><span class="kw">cellStats</span>(preds, mean)</a>
<a class="sourceLine" id="cb233-31" data-line-number="31"><span class="kw">levelplot</span>(preds <span class="op">-</span><span class="st"> </span>X, <span class="dt">at=</span><span class="kw">seq</span>(<span class="op">-</span><span class="fl">0.5</span>,<span class="fl">0.5</span>, <span class="dt">length.out=</span><span class="dv">10</span>),</a>
<a class="sourceLine" id="cb233-32" data-line-number="32">          <span class="dt">par.settings =</span> RdBuTheme)</a>
<a class="sourceLine" id="cb233-33" data-line-number="33"></a>
<a class="sourceLine" id="cb233-34" data-line-number="34">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;results/validation.csv&quot;</span>)</a>
<a class="sourceLine" id="cb233-35" data-line-number="35"></a>
<a class="sourceLine" id="cb233-36" data-line-number="36"><span class="co"># prepare 3 new data.frame with the observed, predicted and the model</span></a>
<a class="sourceLine" id="cb233-37" data-line-number="37">modRK &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">obs =</span> dat<span class="op">$</span>OCSKGM, <span class="dt">mod =</span> dat<span class="op">$</span>MKD_OCSKGM_RK,</a>
<a class="sourceLine" id="cb233-38" data-line-number="38">                    <span class="dt">model =</span> <span class="st">&quot;RK&quot;</span>)</a>
<a class="sourceLine" id="cb233-39" data-line-number="39"></a>
<a class="sourceLine" id="cb233-40" data-line-number="40">modRF &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">obs =</span> dat<span class="op">$</span>OCSKGM, <span class="dt">mod =</span> dat<span class="op">$</span>MKD_OCSKGM_rf,</a>
<a class="sourceLine" id="cb233-41" data-line-number="41">                    <span class="dt">model =</span> <span class="st">&quot;RF&quot;</span>)</a>
<a class="sourceLine" id="cb233-42" data-line-number="42"></a>
<a class="sourceLine" id="cb233-43" data-line-number="43">modSVM &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">obs =</span> dat<span class="op">$</span>OCSKGM, <span class="dt">mod =</span> dat<span class="op">$</span>MKD_OCSKGM_svm,</a>
<a class="sourceLine" id="cb233-44" data-line-number="44">                     <span class="dt">model =</span> <span class="st">&quot;SVM&quot;</span>)</a>
<a class="sourceLine" id="cb233-45" data-line-number="45"></a>
<a class="sourceLine" id="cb233-46" data-line-number="46"><span class="co"># merge the 3 data.frames into one</span></a>
<a class="sourceLine" id="cb233-47" data-line-number="47">modData &lt;-<span class="st"> </span><span class="kw">rbind</span>(modRK, modRF, modSVM)</a>
<a class="sourceLine" id="cb233-48" data-line-number="48"></a>
<a class="sourceLine" id="cb233-49" data-line-number="49"><span class="kw">summary</span>(modData)</a>
<a class="sourceLine" id="cb233-50" data-line-number="50"></a>
<a class="sourceLine" id="cb233-51" data-line-number="51"><span class="co">#Load the openair library</span></a>
<a class="sourceLine" id="cb233-52" data-line-number="52"><span class="kw">library</span>(openair)</a>
<a class="sourceLine" id="cb233-53" data-line-number="53"></a>
<a class="sourceLine" id="cb233-54" data-line-number="54">modsts &lt;-<span class="st"> </span><span class="kw">modStats</span>(modData,<span class="dt">obs =</span> <span class="st">&quot;obs&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;mod&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;model&quot;</span>)</a>
<a class="sourceLine" id="cb233-55" data-line-number="55"></a>
<a class="sourceLine" id="cb233-56" data-line-number="56">modsts</a>
<a class="sourceLine" id="cb233-57" data-line-number="57"></a>
<a class="sourceLine" id="cb233-58" data-line-number="58"><span class="kw">TaylorDiagram</span>(modData, <span class="dt">obs =</span> <span class="st">&quot;obs&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;mod&quot;</span>, <span class="dt">group =</span> <span class="st">&quot;model&quot;</span>,</a>
<a class="sourceLine" id="cb233-59" data-line-number="59">              <span class="dt">cols =</span> <span class="kw">c</span>(<span class="st">&quot;orange&quot;</span>, <span class="st">&quot;red&quot;</span>,<span class="st">&quot;blue&quot;</span>), <span class="dt">cor.col=</span><span class="st">&#39;brown&#39;</span>,</a>
<a class="sourceLine" id="cb233-60" data-line-number="60">              <span class="dt">rms.col=</span><span class="st">&#39;black&#39;</span>)</a>
<a class="sourceLine" id="cb233-61" data-line-number="61"></a>
<a class="sourceLine" id="cb233-62" data-line-number="62"><span class="kw">conditionalQuantile</span>(modData,<span class="dt">obs =</span> <span class="st">&quot;obs&quot;</span>, <span class="dt">mod =</span> <span class="st">&quot;mod&quot;</span>, <span class="dt">type =</span> <span class="st">&quot;model&quot;</span>)</a></code></pre></div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="technical-overview-and-the-checklist.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/FAO-GSP/SOC-Mapping-Cookbook/edit/master/13-code-examples.Rmd",
"text": "Edit"
},
"download": ["SOCMapping.pdf", "SOCMapping.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
